<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>VBlocks - Profil</title>
  <link rel="stylesheet" href="style/main.css"/>
  <style>
    body {
      margin: 0;
      min-height: 100vh;
      font-family: 'Quicksand', Arial, sans-serif;
      background: radial-gradient(ellipse at 60% 40%, #7061e8 0%, #5db9e3 55%, #483070 100%);
    }
    .top-bar {
      width: 100%;
      display: flex; justify-content: space-between; align-items: center;
      position: absolute; top: 0; left: 0; right: 0;
      height: 65px; z-index: 30; padding: 0 12px; box-sizing: border-box;
      pointer-events: none;
    }
    .top-left, .top-right { display: flex; align-items: center; pointer-events: all; }
    .top-left { flex: 1; }
    .top-right { gap: 20px; }
    .btn-back { display: flex; align-items: center; justify-content: center;
      width: 48px; height: 48px; border-radius: 50%;
      background: none; border: none; transition: background 0.14s;
      margin-left: -8px; cursor: pointer; padding: 0; }
    .btn-back svg { width: 32px; height: 32px; display: block; }
    .btn-back:hover { background: #23236028; }
    .btn-icon { background: none; border: none; display: flex; align-items: center; justify-content: center;
      padding: 6px; cursor: pointer; border-radius: 50%; transition: background 0.15s; width: 44px; height: 44px; }
    .btn-icon img { width: 26px; height: 26px; display: block; filter: drop-shadow(0 1px 2px #2228); }
    .btn-icon:hover { background: #23236022; }

    .profil-content {
      display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
      min-height: 100vh; padding-top: 6.2em; gap: 1.8em;
    }
    .profil-logo {
      width: 94px; margin-bottom: 0.3em; margin-top: -1.1em;
      filter: drop-shadow(0 5px 18px #a3c8fd44);
      border-radius: 1.1em; user-select: none; pointer-events: none;
    }
    .profil-title {
      font-size: 2em; font-weight: 900; color: #fff; letter-spacing: 0.03em;
      text-align: center; margin-bottom: 0.3em;
      text-shadow: 0 3px 16px #2e6ead44, 0 1px 1px #fff7;
    }
    .profil-id {
      font-size: 1.13em; color: #d6ffe6; font-weight: 800; letter-spacing: 0.09em;
      background: rgba(55,192,120,0.17);
      padding: 0.36em 1.1em; border-radius: 1.3em;
      box-shadow: 0 2px 12px #0ae58c20; text-shadow: 0 1px 2px #2223;
    }
    .profil-change-pseudo {
      background: none; border: 2px dashed #b8ffdb88; color: #ffffffee; border-radius: 1.3em;
      padding: 0.4em 1em; font-size: 0.95em; font-weight: 700; cursor: pointer;
      box-shadow: 0 2px 8px #0ae58c33; transition: background 0.15s, transform 0.13s;
    }
    .profil-change-pseudo:hover { background: rgba(255,255,255,0.1); transform: scale(1.03); }

    .theme-btn-vb, .applis-btn-vb {
      width: 98%; margin: 0.5em auto 0 auto;
      background: linear-gradient(90deg,#70dcff 0%,#b2ff9d 100%); color: #246133;
      border: none; border-radius: 1.2em; font-size: 1.13em; font-weight: 900; padding: 0.94em 0;
      cursor: pointer; box-shadow: 0 2px 16px #b7ffe644; transition: background 0.15s, color 0.13s, transform 0.14s;
      outline: none; letter-spacing: 0.04em; display: flex; align-items: center; justify-content: center; gap: 0.67em; text-align: center;
    }
    .theme-btn-vb:active, .applis-btn-vb:active { background: linear-gradient(90deg,#47bcd3 0%,#a6f382 100%); color: #143e1a; }

    .applis-reward-note {
      width: 96%; color: #f7fffb; font-weight: 800; text-align: center;
      font-size: 0.98em; letter-spacing: 0.02em; text-shadow: 0 1px 4px #032b14aa; margin-top: -0.5em;
    }

    @media (max-width: 520px) {
      .profil-title { font-size: 1.18em;}
      .profil-logo { width: 68px; margin-top: 0.1em;}
      .profil-content { padding-top: 3.7em; }
      .top-bar { padding-left: 2px; padding-right: 2px; }
    }

    .popup-bg { position: fixed; inset: 0; background: rgba(0,0,0,0.5);
      display: none; justify-content: center; align-items: center; z-index: 5000; }
    .popup-bg.active { display: flex; }
    .popup-box { background: #fff; border-radius: 16px; padding: 2em 1.4em;
      width: 90%; max-width: 350px; text-align: center; box-shadow: 0 8px 36px #0003; }
    .popup-box input { width: 90%; padding: 0.7em; font-size: 1.05em;
      border: 1px solid #ccc; border-radius: 8px; margin-top: 1em; }
    .popup-box button { margin-top: 1.2em; margin-right: 0.4em; padding: 0.6em 1.4em;
      border-radius: 8px; font-weight: 700; border: none; cursor: pointer;
      background: #38a75f; color: #fff; }
    .popup-box button:last-child { background: #eee; color: #333; }
    #pseudoError { color: #d33; font-size: 0.95em; margin-top: 0.5em; min-height: 1.1em; }

    /* ===== POPUP THÈMES façon Boutique ===== */
    .popup-theme-bg { position: fixed; inset: 0; z-index: 1000; background: rgba(24,44,26,0.68);
      display: none; align-items: center; justify-content: center; }
    .popup-theme-bg.active { display: flex; }
    .theme-shop-card { background:#fff; border-radius:20px; box-shadow:0 16px 48px #0006; width:min(96vw,920px); padding:16px; }
    .theme-shop-header { display:flex; align-items:center; justify-content:center; position:relative; margin-bottom:8px; }
    .theme-close { position:absolute; right:6px; top:6px; border:none; background:transparent; font-size:18px; padding:6px 10px; border-radius:10px; cursor:pointer; }
    .theme-close:hover { background:#0000000f; }
    .theme-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); gap:14px; margin-top:10px; }
    .theme-card { border:1px solid #e5e7eb; border-radius:14px; overflow:hidden; background:#f8fafc; cursor:pointer; transition:transform .12s, box-shadow .12s; }
    .theme-card:hover { transform:translateY(-2px); box-shadow:0 10px 28px #0001; }
    .theme-thumb { width:100%; height:120px; object-fit:cover; display:block; background:#ddd; }
    .theme-meta { padding:10px; display:flex; align-items:center; justify-content:space-between; }
    .theme-name { font-weight:800; }
    .theme-lock { font-size:12px; opacity:.7; }
    .theme-card.locked { filter:grayscale(1); opacity:.6; cursor:not-allowed; }
    .theme-card.active { outline:3px solid #22c55e; }
    .theme-preview { display:grid; grid-template-columns:280px 1fr; gap:16px; align-items:center; }
    @media (max-width:760px){ .theme-preview{ grid-template-columns:1fr; } }
    .preview-frame { border:1px solid #e5e7eb; border-radius:16px; padding:10px; background:#f8fafc; }
    .preview-ui { height:180px; border-radius:12px; display:grid; place-items:center; gap:8px; }
    .preview-logo { font-weight:900; }
    .preview-chip { padding:6px 10px; border-radius:999px; background:#e2e8f0; }
    .preview-btn { padding:8px 14px; border-radius:10px; background:#111; color:#fff; font-weight:800; }
    .preview-caption { text-align:center; margin-top:6px; color:#666; font-weight:700; }
    .theme-actions { display:flex; gap:10px; justify-content:center; align-items:center; padding:14px 0; }
    .vb-btn-validate, .vb-btn-cancel { padding:.67em 1.7em; border-radius:1em; font-weight:800; border:none; font-size:1.03em; cursor:pointer; margin:0 .7em; }
    .vb-btn-validate { background:#59e7aa; color:#093c1c; } .vb-btn-validate:active{ background:#2ad680; }
    .vb-btn-cancel { background:#eee; color:#6d787a; } .vb-btn-cancel:active{ background:#c7c7c7; }

    @keyframes popupfade { from { opacity:0; transform: translateY(38px) scale(.96);} to { opacity:1; transform:none; } }
  </style>
</head>
<body>
  <div class="top-bar">
    <div class="top-left">
      <a href="index.html" class="btn-back" title="Retour" tabindex="0">
        <svg viewBox="0 0 36 36" fill="none">
          <path d="M23.5 28L15 19.5L23.5 11" stroke="#fff" stroke-width="3.2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </a>
    </div>
    <div class="top-right">
      <a href="profil.html" class="btn-icon" title="Profil">
        <img src="assets/icons/user.svg" alt="Profil" />
      </a>
      <a href="parametres.html" class="btn-icon" title="Paramètres">
        <img src="assets/icons/settings.svg" alt="Paramètres" />
      </a>
    </div>
  </div>

  <div class="profil-content">
    <img class="profil-logo" src="assets/images/vblocks-logo.png" alt="VBlocks" draggable="false"/>
    <div class="profil-title" data-i18n="profil.title">Mon Profil</div>

    <div class="profil-id" id="profilPseudo">MonPseudo</div>

    <button class="profil-change-pseudo" id="btnChangePseudo">
      <span data-i18n="profil.btn.changePseudo">Modifier mon pseudo</span>
    </button>

    <button class="theme-btn-vb" id="changeThemeBtn">
      <span data-i18n="profil.btn.theme">Thèmes</span>
    </button>


    <button class="applis-btn-vb" id="applisBtn">
      <span data-i18n="profil.btn.applis">Nos applis</span>
    </button>

  
  </div>

  <!-- Popup Pseudo -->
  <div class="popup-bg" id="popupPseudo">
    <div class="popup-box">
      <h2 data-i18n="profil.popup.pseudoTitle">Ton nouveau pseudo</h2>
      <input type="text" id="newPseudo" maxlength="20" placeholder="Nouveau pseudo"/>
      <div id="pseudoError"></div>
      <button id="btnSavePseudo"><span data-i18n="profil.popup.validate">Valider</span></button>
      <button id="btnCancelPseudo"><span data-i18n="profil.popup.cancel">Annuler</span></button>
    </div>
  </div>

  <!-- ===== POPUP THÈMES (style Boutique) ===== -->
  <div id="themeModal" class="popup-theme-bg">
    <div class="theme-shop-card">
      <div class="theme-shop-header">
        <h2 data-i18n="theme.popup.title">Choisis ton thème VBlocks</h2>
        <button id="themeModalClose" class="theme-close" aria-label="Fermer">✕</button>
      </div>

      <!-- Aperçu live -->
      <div class="theme-preview">
        <div class="preview-frame">
          <div id="themePreview" class="preview-ui">
            <div class="preview-logo">VBlocks</div>
            <div class="preview-chip">Cartes / Badges</div>
            <div class="preview-btn">Bouton</div>
          </div>
        </div>
        <div class="preview-caption" data-i18n="theme.preview.legend">Aperçu en direct</div>
      </div>

      <!-- Grille des thèmes -->
      <div id="themeGrid" class="theme-grid"></div>

      <!-- Grande image (comme Boutique) -->
      <div class="modal-body" style="padding:14px 0 0">
        <img id="themeModalImage" src="" alt="" />
      </div>

      <div class="theme-actions">
        <button id="themeUse" class="vb-btn-validate">
          <span data-i18n="theme.popup.use">Utiliser ce thème</span>
        </button>
        <button id="themeCancel" class="vb-btn-cancel">
          <span data-i18n="theme.popup.cancel">Annuler</span>
        </button>
      </div>
    </div>
  </div>

  <div id="toast" style="position:fixed;left:50%;bottom:20px;transform:translateX(-50%);background:#111;color:#fff;padding:10px 14px;border-radius:10px;display:none;z-index:9999"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="js/userData.js"></script>
  <script src="js/pub.js"></script>
  <script>
    // ---------- i18n safe ----------
    function i18nSafe(key, fb){ try{ return (window.i18nGet?.(key)) || fb }catch{ return fb } }

    // ---------- Apps partenaires (détection + crédit) ----------
    const APPS_TO_CHECK = [
      { appId: 'vblocks', packageName: 'com.vboldstudio.VBlocks' },
      { appId: 'vfindz',  packageName: 'com.vboldstudio.VFindz' },
      { appId: 'vzone',   packageName: 'com.vboldstudio.VZone' }
    ];
    async function isAppInstalledAndroid(pkg){
      try{
        const AppChecker=(window.Capacitor?.Plugins||{}).AppChecker;
        if(!AppChecker?.isInstalled) return false;
        const res=await AppChecker.isInstalled({package:pkg});
        return !!res?.installed;
      }catch{return false;}
    }
    async function creditIfEligible(appId){
      const user=(window.supabase?.auth?.user && supabase.auth.user());
      if(!user) return {ok:false,reason:'no-user'};
      const {error}=await supabase.rpc('grant_app_download_reward',{user_id:user.id, app_id:appId});
      if(error){
        if((error.message||'').toLowerCase().includes('unique')) return {ok:false,reason:'already-credited'};
        return {ok:false,reason:'rpc-error',details:error.message};
      }
      return {ok:true};
    }
    function toast(msg){ const el=document.getElementById('toast'); el.textContent=msg; el.style.display='block'; setTimeout(()=>el.style.display='none',2600); }
    async function checkInstalledAppsAndGrant(showNone=false){
      if(!/Android/i.test(navigator.userAgent)) return;
      let found=0, credited=0;
      for(const app of APPS_TO_CHECK){
        if(await isAppInstalledAndroid(app.packageName)){
          found++; const r=await creditIfEligible(app.appId); if(r.ok) credited++;
        }
      }
      if(found>0){
        const m=i18nSafe('profil.applis.check.toastDetected','{count} appli(s) détectée(s), crédits: {credited}')
                    .replace('{count}',found).replace('{credited}',credited);
        toast(m);
      } else if (showNone) {
        toast(i18nSafe('profil.applis.check.toastNone','Aucune application partenaire détectée'));
      }
    }

    // ---------- THEMES (grille + image + preview + utiliser) ----------
    const THEMES_SHOP=[
      {key:'neon',name:'Neon'},{key:'bubble',name:'Bubble'},{key:'nature',name:'Nature'},
      {key:'nuit',name:'Nuit'},{key:'retro',name:'Retro'},{key:'vitraux',name:'Vitraux'},
      {key:'angelique',name:'Angelique'},{key:'luxury',name:'Luxury'},{key:'space',name:'Space'},{key:'cyber',name:'Cyber'}
    ];

    async function getUnlockedThemes(){
      const userId=localStorage.getItem('user_id');
      try{
        const sb=(window.sb||window.supabase); if(!sb||!userId) throw 0;
        const {data,error}=await sb.from('users').select('themes_possedes').eq('id',userId).single();
        if(!error && Array.isArray(data?.themes_possedes)) return data.themes_possedes;
      }catch{}
      try{ const local=JSON.parse(localStorage.getItem('unlockedVBlocksThemes')||'[]'); if(Array.isArray(local)&&local.length) return local;}catch{}
      return ['neon'];
    }
    async function setUnlockedThemes(list){
      localStorage.setItem('unlockedVBlocksThemes',JSON.stringify(list));
      const user=(window.supabase?.auth?.user && supabase.auth.user());
      try{ if(user) await supabase.from('users').update({themes_possedes:list}).eq('id',user.id);}catch{}
    }

    function setPreviewTheme(themeKey){
      // Aperçu live minimal (tu peux brancher ton système de variables CSS si tu en as un)
      const prev=document.getElementById('themePreview');
      prev.style.background = (themeKey==='nuit' || themeKey==='luxury') ? '#111' : '#f8fafc';
      prev.querySelector('.preview-btn').style.background = (themeKey==='nuit' || themeKey==='luxury') ? '#22c55e' : '#111';
    }

    async function openThemeModal(){
      const modal=document.getElementById('themeModal');
      const grid=document.getElementById('themeGrid');
      const img=document.getElementById('themeModalImage');
      const btnUse=document.getElementById('themeUse');
      const btnCancel=document.getElementById('themeCancel');
      const btnClose=document.getElementById('themeModalClose');

      const unlocked=await getUnlockedThemes();
      const current=localStorage.getItem('themeVBlocks')||'neon';
      let selected=current;

      grid.innerHTML = THEMES_SHOP.map(t=>{
        const locked = !unlocked.includes(t.key);
        const webp = `assets/modes/${t.key}.webp`;
        const png  = `assets/modes/${t.key}.png`;
        return `
          <div class="theme-card ${locked?'locked':''}" data-theme="${t.key}" tabindex="0">
            <img class="theme-thumb" src="${webp}" onerror="this.onerror=null;this.src='${png}'" alt="${t.name}">
            <div class="theme-meta">
              <div class="theme-name">${t.name}</div>
              <div class="theme-lock">${locked ? (i18nSafe('theme.item.lockedSuffix','🔒')) : i18nSafe('theme.item.unlocked','OK')}</div>
            </div>
          </div>`;
      }).join('');

      grid.querySelectorAll('.theme-card').forEach(card=>{
        if(card.classList.contains('locked')) return;
        if(card.dataset.theme===selected) card.classList.add('active');
        card.addEventListener('click',()=>{
          grid.querySelectorAll('.theme-card').forEach(c=>c.classList.remove('active'));
          card.classList.add('active');
          selected=card.dataset.theme;
          setPreviewTheme(selected);
          const webp=`assets/modes/${selected}.webp`; const png=`assets/modes/${selected}.png`;
          img.src=webp; img.onerror=()=>{ if(img.src.endsWith('.webp')) img.src=png; };
        });
      });

      // init preview + image
      setPreviewTheme(selected);
      img.src=`assets/modes/${selected}.webp`;
      img.onerror=()=>{ if(img.src.endsWith('.webp')) img.src=`assets/modes/${selected}.png`; };

      btnUse.onclick = async ()=>{
        if(!selected) return;
        localStorage.setItem('themeVBlocks',selected);
        document.body.setAttribute('data-theme',selected);
        try{ const user=(window.supabase?.auth?.user && supabase.auth.user()); if(user){ await supabase.from('users').update({theme_vblocks:selected}).eq('id',user.id);} }catch{}
        modal.classList.remove('active');
        location.reload(); // retire si tu préfères sans reload
      };
      btnCancel.onclick = ()=> modal.classList.remove('active');
      btnClose.onclick  = ()=> modal.classList.remove('active');

      modal.classList.add('active');
    }

    // ---------- Page wiring ----------
    window.addEventListener("DOMContentLoaded", async () => {
      // Thème initial
      let user=null;
      if (window.supabase?.auth && typeof supabase.auth.user === "function") user=supabase.auth.user();
      if (user) {
        const { data, error } = await supabase.from('users').select('theme_vblocks').eq('id', user.id).single();
        const theme = (!error && data && data.theme_vblocks) ? data.theme_vblocks : (localStorage.getItem('themeVBlocks') || 'neon');
        localStorage.setItem('themeVBlocks', theme);
        document.body.setAttribute('data-theme', theme);
      } else {
        const theme = localStorage.getItem('themeVBlocks') || 'neon';
        document.body.setAttribute('data-theme', theme);
      }

      const p = localStorage.getItem("pseudo") || "MonPseudo";
      document.getElementById("profilPseudo").textContent = p;

      setupPseudoPopup();
      updatePseudoUI();

      // Bouton Thèmes → ouvre la popup façon Boutique
      document.getElementById("changeThemeBtn").onclick = openThemeModal;

      if (window.i18nGet) {
        const ph = window.i18nGet('profil.popup.placeholder');
        if (ph) document.getElementById('newPseudo').setAttribute('placeholder', ph);
      }

      // Détection applis partenaires (silencieux)
      checkInstalledAppsAndGrant(false);

      // Autres boutons
      document.getElementById("amisBtn").onclick = () => { window.location.href = "amis.html"; };
      document.getElementById("applisBtn").onclick = async () => {
        await checkInstalledAppsAndGrant(true);
        // si tu ne veux plus de redirection : commente la ligne ci-dessous
        // window.location.href = "applis.html";
      };
    });

    // ---- popup pseudo ----
    function setupPseudoPopup() {
      const popup = document.getElementById('popupPseudo');
      const btnOpen = document.getElementById('btnChangePseudo');
      const btnSave = document.getElementById('btnSavePseudo');
      const btnCancel = document.getElementById('btnCancelPseudo');
      const input = document.getElementById('newPseudo');
      const err = document.getElementById('pseudoError');

      btnOpen.onclick = () => {
        err.textContent = '';
        input.value = localStorage.getItem("pseudo") || '';
        popup.classList.add('active');
        setTimeout(()=>input.focus(), 50);
      };
      btnCancel.onclick = () => popup.classList.remove('active');

      btnSave.onclick = async () => {
        const v = (input.value || '').trim();
        if (!v) { err.textContent = i18nSafe('profil.popup.error.empty','Entre un pseudo.'); return; }
        if (v.length > 20) { err.textContent = i18nSafe('profil.popup.error.length','20 caractères max.'); return; }
        try {
          localStorage.setItem("pseudo", v);
          const user = (window.supabase?.auth?.user && supabase.auth.user());
          if (user) { await supabase.from('users').update({ pseudo: v }).eq('id', user.id); }
          document.getElementById("profilPseudo").textContent = v;
          err.textContent = i18nSafe('profil.popup.success','Pseudo mis à jour.');
          setTimeout(() => popup.classList.remove('active'), 500);

        } catch(e) {}
      };
    }
    function updatePseudoUI() {
      const current = localStorage.getItem("pseudo");
      if (current) document.getElementById("profilPseudo").textContent = current;
    }
  </script>
</body>
</html>
