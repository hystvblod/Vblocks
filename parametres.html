<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title data-i18n="header.title.settings">Paramètres</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style/main.css" />
  <style>
    html, body {
      height: auto !important;
      min-height: 100vh;
      overflow-y: auto !important;
    }
    body {
      margin: 0;
      font-family: 'Quicksand', Arial, sans-serif;
      background: radial-gradient(ellipse at 60% 40%, #7061e8 0%, #5db9e3 55%, #483070 100%);
      color: #fff;
    }
    .main-content {
      display: flex;
      flex-direction: column;
      width: 100vw;
      max-width: 430px;
      box-sizing: border-box;
      align-items: center;
      justify-content: flex-start;
      margin: 0 auto;
      min-height: unset !important;
      height: auto !important;
    }
    .top-bar {
      width: 100%;
      max-width: 430px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      padding: 10px 10px 0 10px;
      position: relative;
      z-index: 10;
      background: transparent;
    }
    .top-bar-row {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      gap: 8px;
    }
    .btn-back {
      background: none;
      border: none;
      display: flex; align-items: center; justify-content: center;
      border-radius: 50%; padding: 4px;
      cursor: pointer;
      width: 42px; height: 42px;
      transition: background 0.15s;
    }
    .btn-back img { width: 28px; height: 28px; filter: drop-shadow(0 1px 2px #0005); }
    .main-title {
      flex: 1;
      font-size: 2em; font-weight: 900;
      color: #fff;
      letter-spacing: 2px; line-height: 1.1;
      text-align: center;
      white-space: pre-line;
      word-break: break-word;
      user-select: none;
      text-shadow: 0 3px 16px #2e6ead44, 0 1px 1px #fff7;
    }
    .profile-row { display: flex; flex-direction: row; gap: 8px; }
    .btn-icon img { width: 27px; height: 27px; }
    .param-container {
      display: flex; flex-direction: column; align-items: center;
      justify-content: flex-start;
      padding-top: 2em; gap: 2em;
      width: 100%;
      max-width: 430px;
      margin: 0 auto;
    }
    .param-group {
      background: rgba(255,255,255,0.1);
      padding: 1.2em 1.5em;
      border-radius: 1.5em;
      box-shadow: 0 2px 10px #0002;
      width: 90%; max-width: 400px;
    }
    label { font-weight: 800; font-size: 1.1em; display: block; margin-bottom: 0.6em; }
    .lang-select {
      display: flex; flex-wrap: wrap; gap: 0.7em; justify-content: center; margin-top: 0.5em;
    }
    .lang-option {
      display: flex; align-items: center; gap: 0.5em;
      padding: 0.35em 0.85em; border-radius: 1em;
      background: #e6f6ea; color: #156c31; border: none; font-weight: 700;
      cursor: pointer; box-shadow: 0 2px 8px #a2dcd220;
      transition: background 0.13s, transform 0.13s;
      font-size: 1.08em;
    }
    .lang-option.selected {
      background: linear-gradient(90deg,#70dcff 0%,#b2ff9d 100%);
      color: #0e4b26; transform: scale(1.06);
    }
    .flag { width: 22px; height: 16px; }
    .switch {
      display: flex; align-items: center; gap: 0.8em; margin-top: 0.7em;
    }
    input[type="checkbox"] {
      width: 24px; height: 24px;
      accent-color: #70dcff;
    }
    button.return-btn {
      background: none; border: 2px dashed #b8ffdb88; color: #fff;
      border-radius: 1.3em; padding: 0.6em 1.4em; font-size: 1em;
      font-weight: 700; cursor: pointer; margin-top: 1em;
    }
    button.return-btn:hover { background: rgba(255, 255, 255, 0.1); }
    .music-btn-img { width: 32px; height: 32px; vertical-align: middle; }

    /* Texte de remerciements un peu plus petit */
    .credits-text {
      margin: 0.2em 0 0;
      line-height: 1.5;
      font-size: 0.98em;
      color: #f0f6ff;
      opacity: 0.95;
    }

    @media (max-width:480px) {
      .main-content, .top-bar { max-width: 100vw; }
      .top-bar { padding: 4px 3px 0 3px; max-width: 99vw; }
      .main-title { font-size: 1.4em; }
      .btn-back { width: 32px; height: 32px; }
      .btn-back img, .btn-icon img { width: 20px; height: 20px; }
    }
  </style>
</head>
<body>
  <div class="main-content">
    <div class="top-bar">
      <div class="top-bar-row">
        <button class="btn-back" id="btn-back" title="Retour" aria-label="Retour">
          <img src="assets/icons/arrow_back.svg" alt="Retour">
        </button>
        <span class="main-title" data-i18n="header.title.settings">Paramètres</span>
        <div class="profile-row">
          <a href="profil.html" class="btn-icon" id="btn-profile" title="Profil">
            <img src="assets/icons/user.svg" alt="Profil">
          </a>
        </div>
      </div>
    </div>

    <div class="param-container">
      <!-- Sélection langue -->
      <div class="param-group">
        <label data-i18n="settings.language.label">Langue de l'interface :</label>
        <div id="langue-select" class="lang-select"></div>
      </div>

      <!-- Publicités -->
      <div class="param-group">
        <label data-i18n="settings.ads.label">Publicités personnalisées :</label>
        <div class="switch">
          <input type="checkbox" id="ads-toggle">
          <span id="ads-label" data-i18n="settings.ads.on">Activée</span>
        </div>
      </div>

      <!-- Pièce fantôme -->
      <div class="param-group">
        <label data-i18n="settings.ghost.label">Afficher la pièce fantôme :</label>
        <div class="switch">
          <input type="checkbox" id="ghost-toggle">
          <span id="ghost-label" data-i18n="settings.ghost.on">Activée</span>
        </div>
      </div>

      <!-- Musique -->
      <div class="param-group">
        <label data-i18n="settings.music.label">Musique :</label>
        <div class="switch" style="gap:0.6em;">
          <button id="music-toggle-btn" aria-label="Musique"
            style="background:none;border:none;cursor:pointer;padding:0;">
            <img id="music-toggle-img" src="assets/icons/volume-2.svg" alt="Musique activée" class="music-btn-img">
          </button>
          <span id="music-toggle-label" data-i18n="settings.music.on">Activée</span>
        </div>
      </div>

      <!-- Remerciements (NOUVEAU) -->
      <div class="param-group">
        <label data-i18n="settings.credits.label">Remerciements</label>
        <p class="credits-text">
          <span data-i18n="settings.credits.text">
            VBoldStudio remercie pour leur soutien, leur créativité et leurs conseils : Arnaud, Angélique, Matthieu, Kimberley, Adrien, Tatiana, Matthieu, Thomas, Lucas.
          </span>
        </p>
      </div>

      <!-- Adresse mail seule -->
      <div style="text-align:center;margin:12px 0;">
        <a href="mailto:help.vblocks@gmail.com">help.vblocks@gmail.com</a>
      </div>
    </div>
  </div>

  <!-- SDK Supabase AVANT userData.js -->
  <script src="js/vendor/supabase-2.42.5.min.js"></script>
  <!-- Script qui utilise Supabase -->
  <script src="js/userData.js"></script>
  <!-- Charger i18n AVANT le script inline pour pouvoir l'appeler -->
  <script src="js/i18n.js"></script>

  <script>
    // Appliquer la traduction au plus tôt
    if (window.i18nTranslateAll) window.i18nTranslateAll();
    window.addEventListener("load", () => {
      if (window.i18nTranslateAll) window.i18nTranslateAll();
      const titleNode = document.querySelector('title[data-i18n]');
      if (titleNode && window.i18n) {
        const key = titleNode.getAttribute('data-i18n');
        try { document.title = window.i18n(key) || document.title; } catch(_) {}
      }
    });

    document.addEventListener("DOMContentLoaded", function() {
      const btnBack = document.getElementById('btn-back');
      if (btnBack) {
        btnBack.addEventListener('click', function(e) {
          e.preventDefault();
          if (window.vibrateIfEnabled) window.vibrateIfEnabled(40);
          if (window.history.length > 1) {
            window.history.back();
          } else {
            window.location.href = "index.html";
          }
        });
      }
      const btnProfile = document.getElementById('btn-profile');
      if (btnProfile) {
        btnProfile.addEventListener('click', function() {
          if (window.vibrateIfEnabled) window.vibrateIfEnabled(30);
        });
      }
    });

    // ====== LANG ======
    const langues = [
      { code: "fr", label: "Français", flag: `<svg class="flag" viewBox="0 0 22 16"><rect width="7.33" height="16" fill="#0055a4"/><rect x="7.33" width="7.34" height="16" fill="#fff"/><rect x="14.67" width="7.33" height="16" fill="#ef4135"/></svg>` },
      { code: "en", label: "English (US)", flag: `<svg class="flag" viewBox="0 0 22 16"><rect width="22" height="16" fill="#b22234"/><g><rect width="22" height="1.23" y="1.23" fill="#fff"/><rect width="22" height="1.23" y="3.69" fill="#fff"/><rect width="22" height="1.23" y="6.15" fill="#fff"/><rect width="22" height="1.23" y="8.61" fill="#fff"/><rect width="22" height="1.23" y="11.07" fill="#fff"/><rect width="22" height="1.23" y="13.53" fill="#fff"/></g><rect width="8.8" height="7" fill="#3c3b6e"/><g fill="#fff"><circle cx="1.2" cy="1" r="0.35"/><circle cx="2.4" cy="1" r="0.35"/><circle cx="3.6" cy="1" r="0.35"/><circle cx="4.8" cy="1" r="0.35"/><circle cx="6" cy="1" r="0.35"/><circle cx="7.2" cy="1" r="0.35"/><circle cx="1.8" cy="2" r="0.35"/><circle cx="3" cy="2" r="0.35"/><circle cx="4.2" cy="2" r="0.35"/><circle cx="5.4" cy="2" r="0.35"/><circle cx="6.6" cy="2" r="0.35"/><circle cx="2.4" cy="3" r="0.35"/><circle cx="3.6" cy="3" r="0.35"/><circle cx="4.8" cy="3" r="0.35"/><circle cx="6" cy="3" r="0.35"/><circle cx="7.2" cy="3" r="0.35"/></g></svg>` },
      { code: "de", label: "Deutsch", flag: `<svg class="flag" viewBox="0 0 22 16"><rect width="22" height="5.33" fill="#000"/><rect y="5.33" width="22" height="5.33" fill="#dd0000"/><rect y="10.67" width="22" height="5.33" fill="#ffce00"/></svg>` },
      { code: "it", label: "Italiano", flag: `<svg class="flag" viewBox="0 0 22 16"><rect width="7.33" height="16" fill="#009246"/><rect x="7.33" width="7.34" height="16" fill="#fff"/><rect x="14.67" width="7.33" height="16" fill="#ce2b37"/></svg>` },
      { code: "es", label: "Español", flag: `<svg class="flag" viewBox="0 0 22 16"><rect width="22" height="16" fill="#aa151b"/><rect y="4" width="22" height="8" fill="#f1bf00"/></svg>` },
      { code: "pt", label: "Português", flag: `<svg class="flag" viewBox="0 0 22 16"><rect width="8" height="16" fill="#00874B"/><rect x="8" width="14" height="16" fill="#FF0000"/><circle cx="9.5" cy="8" r="3.3" fill="#fff" stroke="#FFD700" stroke-width="1"/><rect x="8.6" y="5.5" width="1.8" height="5" fill="#00874B" stroke="#FFD700" stroke-width="0.5"/><circle cx="9.5" cy="8" r="1.2" fill="#00874B" stroke="#FFD700" stroke-width="0.4"/></svg>` },
      { code: "ptbr", label: "Português (BR)", flag: `<svg class="flag" viewBox="0 0 22 16"><rect width="22" height="16" fill="#3eae47"/><ellipse cx="11" cy="8" rx="8" ry="6" fill="#ffcc29"/><circle cx="11" cy="8" r="4" fill="#3e4095"/><path d="M8.3 8.4a3 3 0 0 1 5.4 0" stroke="#fff" stroke-width=".8" fill="none"/><text x="11" y="10.5" font-size="3.3" fill="#fff" text-anchor="middle" alignment-baseline="middle" font-family="Arial">BR</text></svg>` },
      { code: "ar", label: "العربية", flag: `<svg class="flag" viewBox="0 0 22 16"><rect width="22" height="16" fill="#fff"/><rect width="22" height="8" y="0" fill="#198754"/><polygon points="5,8 13,4 13,12" fill="#fff"/><circle cx="16" cy="8" r="3" fill="#198754"/></svg>` },
      { code: "idn", label: "Bahasa Indonesia", flag: `<svg class="flag" viewBox="0 0 22 16"><rect width="22" height="8" y="0" fill="#ff0000"/><rect width="22" height="8" y="8" fill="#fff"/></svg>` },
      { code: "ja", label: "日本語", flag: `<svg class="flag" viewBox="0 0 22 16"><rect width="22" height="16" fill="#fff"/><circle cx="11" cy="8" r="4" fill="#bc002d"/></svg>` },
      { code: "ko", label: "한국어", flag: `<svg class="flag" viewBox="0 0 22 16"><rect width="22" height="16" fill="#fff"/><circle cx="11" cy="8" r="4" fill="#003478"/><circle cx="11" cy="8" r="2.5" fill="#c60c30"/></svg>` },
    ];
    const langueSelect = document.getElementById("langue-select");
    let selectedLang = localStorage.getItem("langue") || "fr";
    langues.forEach(l => {
      const opt = document.createElement('div');
      opt.className = 'lang-option' + (l.code === selectedLang ? ' selected' : '');
      opt.innerHTML = l.flag + '<span style="margin-left:0.35em;">' + l.label + '</span>';
      opt.onclick = async () => {
        localStorage.setItem("langue", l.code);
        document.querySelectorAll('.lang-option').forEach(o => o.classList.remove('selected'));
        opt.classList.add('selected');
        if (window.setLang) window.setLang(l.code);
        // Mise à jour en base (users.lang)
        try {
          if (window.userData?.updateLangDirect) {
            await window.userData.updateLangDirect(l.code);
          }
        } catch(e){}
      };
      langueSelect.appendChild(opt);
    });
  </script>

  <script>
    // ====== ADS CONSENT (toggle) ======
    (function(){
      const CONSENT_KEY = "rgpdConsent";
      const ADS_KEY     = "adsConsent";
      const ADS_ENABLED = "adsEnabled";

      const adsToggle = document.getElementById('ads-toggle');
      const adsLabel  = document.getElementById('ads-label');

      function refreshAdsLabel() {
        const on = adsToggle.checked;
        adsLabel.textContent = on
          ? (window.i18nGet ? window.i18nGet('settings.ads.on') || 'Activée' : 'Activée')
          : (window.i18nGet ? window.i18nGet('settings.ads.off') || 'Désactivée' : 'Désactivée');
      }

      async function loadConsentFromCloudThenLocal() {
        try {
          if (window.bootstrapAuthAndProfile) await window.bootstrapAuthAndProfile();
          if (window.sb?.rpc) {
            const { data, error } = await window.sb.rpc('get_ads_consent');
            if (!error && data) {
              // data = 'accept' | 'refuse'
              localStorage.setItem(CONSENT_KEY, data);
              if (data === 'accept') {
                localStorage.setItem(ADS_KEY, 'yes');
                localStorage.setItem(ADS_ENABLED, 'true');
              } else {
                localStorage.setItem(ADS_KEY, 'no');
                localStorage.setItem(ADS_ENABLED, 'false');
              }
            }
          }
        } catch(e) { /* non bloquant */ }

        // Applique au toggle
        try {
          const consent = localStorage.getItem(CONSENT_KEY);
          const adsYes  = localStorage.getItem(ADS_KEY) === 'yes';
          if (consent === 'accept') {
            adsToggle.checked = adsYes; // si accept mais pas personnalisée → off
          } else if (consent === 'refuse') {
            adsToggle.checked = false;
          } else {
            // jamais choisi → on reflète l'état local
            adsToggle.checked = (localStorage.getItem(ADS_ENABLED) === 'true');
          }
        } catch(_) {}
        refreshAdsLabel();
      }

      async function persistConsent(toChecked) {
        // Règle choisie :
        // - Toggle = ON  → consent global = accept + publicités personnalisées YES
        // - Toggle = OFF → consent global = refuse
        const willAccept = !!toChecked;

        localStorage.setItem(CONSENT_KEY, willAccept ? 'accept' : 'refuse');
        localStorage.setItem(ADS_KEY,     willAccept ? 'yes' : 'no');
        localStorage.setItem(ADS_ENABLED, willAccept ? 'true' : 'false');

        // Cloud
        try {
          if (window.bootstrapAuthAndProfile) await window.bootstrapAuthAndProfile();
          if (window.sb?.rpc) {
            await window.sb.rpc('update_ads_consent', { new_consent: willAccept ? 'accept' : 'refuse' });
          }
        } catch(e) { console.warn('[param] update_ads_consent', e?.message || e); }

        // Si on vient de passer en accept+yes, on peut initialiser les pubs
        try {
          if (willAccept && typeof window.applyConsentFromStorage === 'function') {
            window.applyConsentFromStorage();
          }
        } catch(_){}
      }

      if (adsToggle) {
        adsToggle.addEventListener('change', async function(){
          refreshAdsLabel();
          await persistConsent(adsToggle.checked);
        });
      }

      document.addEventListener('DOMContentLoaded', loadConsentFromCloudThenLocal);
    })();
  </script>

  <!-- Ghost + Music (inchangés) -->
  <script>
    document.addEventListener('DOMContentLoaded', function(){
      // Ghost toggle (existant)
      const ghostToggle = document.getElementById('ghost-toggle');
      const ghostLabel  = document.getElementById('ghost-label');
      try {
        const g = localStorage.getItem('ghostEnabled');
        ghostToggle.checked = (g === null) ? true : (g === 'true');
        ghostLabel.textContent = ghostToggle.checked ? (window.i18nGet ? window.i18nGet('settings.ghost.on') || 'Activée' : 'Activée')
                                                     : (window.i18nGet ? window.i18nGet('settings.ghost.off') || 'Désactivée' : 'Désactivée');
        ghostToggle.addEventListener('change', function(){
          localStorage.setItem('ghostEnabled', ghostToggle.checked ? 'true' : 'false');
          ghostLabel.textContent = ghostToggle.checked ? (window.i18nGet ? window.i18nGet('settings.ghost.on') || 'Activée' : 'Activée')
                                                       : (window.i18nGet ? window.i18nGet('settings.ghost.off') || 'Désactivée' : 'Désactivée');
        });
      } catch(_){}

      // Music toggle (existant via userData.js)
      const btn = document.getElementById('music-toggle-btn');
      const img = document.getElementById('music-toggle-img');
      const lbl = document.getElementById('music-toggle-label');
      function syncMusicUI() {
        const muted = (localStorage.getItem('alwaysMuteMusic') === 'true');
        img.src = muted ? 'assets/icons/volume-x.svg' : 'assets/icons/volume-2.svg';
        lbl.textContent = muted ? (window.i18nGet ? window.i18nGet('settings.music.off') || 'Coupée' : 'Coupée')
                                : (window.i18nGet ? window.i18nGet('settings.music.on')  || 'Activée' : 'Activée');
      }
      if (btn) {
        btn.addEventListener('click', function(){
          const muted = (localStorage.getItem('alwaysMuteMusic') === 'true');
          if (typeof window.setMusicAlwaysMuted === 'function') {
            window.setMusicAlwaysMuted(!muted);
          } else {
            localStorage.setItem('alwaysMuteMusic', (!muted) ? 'true' : 'false');
          }
          syncMusicUI();
        });
      }
      syncMusicUI();
    });
  </script>
</body>
</html>
