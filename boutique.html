<!DOCTYPE html>
<html lang="fr">
<head>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.42.5/dist/umd/supabase.min.js"></script>
  <script src="js/userData.js"></script>
  <script src="js/i18n.js"></script>
  <meta charset="UTF-8">
  <title data-i18n="boutique.titre"></title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="style/main.css">
  <style>
    html, body { height:auto; min-height:100%; overflow:auto; }
    body { overscroll-behavior-y:auto; }
    .container-boutique { padding-bottom: 80px; }
    .achats-list, .themes-list {
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 14px;
    }
    .themes-list { margin-top: .5rem; }
    .theme-card.special-cartouche {
      cursor: pointer;
      transition: transform .06s ease, box-shadow .2s ease;
      user-select: none;
      align-items: center;
      justify-content: space-between;
    }
    .theme-card.special-cartouche:hover{ transform: translateY(-1px); }
    .theme-card .theme-ico{
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 56px;
      height: 56px;
      border-radius: 12px;
      overflow: hidden;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.08);
    }
    .theme-card .theme-ico img{
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .theme-card .theme-label{
      font-weight: 700;
      letter-spacing: .2px;
    }
    .theme-card.unlocked { opacity: 1; }
    .theme-card.locked   { opacity: .95; }
    .modal-backdrop {
      position: fixed; inset: 0;
      background: rgba(0,0,0,.58);
      display: none;
      align-items: center; justify-content: center;
      z-index: 9999;
      backdrop-filter: blur(2px);
    }
    .modal {
      width: min(520px, 92vw);
      border-radius: 16px;
      background: var(--card-bg, #17181c);
      color: var(--body-color, #e9e9e9);
      border: 1px solid rgba(255,255,255,0.08);
      box-shadow: 0 12px 40px rgba(0,0,0,.4);
      overflow: hidden;
    }
    .modal-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      font-weight: 700;
    }
    .modal-body { padding: 14px 16px 4px 16px; text-align: center; }
    .modal-body img {
      width: 100%; height: auto; border-radius: 12px;
      background: rgba(255,255,255,0.03);
    }
    .modal-actions {
      display: flex; gap: 10px; justify-content: center; align-items: center;
      padding: 16px;
    }
    .btn {
      appearance: none; border: 0; border-radius: 12px;
      padding: 12px 16px; font-weight: 700; cursor: pointer;
    }
    .btn-primary {
      background: linear-gradient(135deg, #5c8df7, #7a5cf7);
      color: #fff;
    }
    .btn-ghost {
      background: transparent; color: #ddd;
      border: 1px solid rgba(255,255,255,.15);
    }
    .badge {
      display: inline-flex; align-items: center; justify-content: center;
      padding: 10px 14px; border-radius: 999px;
      background: rgba(255,255,255,.08); color: #ddd; font-weight: 700;
      border: 1px solid rgba(255,255,255,.12);
    }
    .modal-close {
      background: transparent; border: 0; color: #bbb; cursor: pointer;
      padding: 8px; border-radius: 10px;
    }
    .modal-close:hover { background: rgba(255,255,255,.06); }
  </style>
</head>
<body>
  <div class="top-bar">
    <div class="top-left">
      <a href="index.html" class="btn-back" title="" tabindex="0" >
        <svg viewBox="0 0 36 36" fill="none">
          <path d="M23.5 28L15 19.5L23.5 11" stroke="#fff" stroke-width="3.2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </a>
    </div>
    <div class="top-right">
      <a href="profil.html" class="btn-icon">
        <img src="assets/icons/user.svg" alt="Profil" />
      </a>
      <a href="parametres.html" class="btn-icon">
        <img src="assets/icons/settings.svg" alt="Paramètres" />
      </a>
    </div>
  </div>

  <div class="container-boutique">
    <div class="shop-title" data-i18n="boutique.titre"></div>
    <div id="soldeVCoins" class="vcoins-bar">
      <img src="assets/images/vcoin.webp" alt="VCoins" class="vcoin-ico">
      <span class="vcoins-solde">--</span>
      <img src="assets/images/jeton.webp" alt="Jetons" class="vcoin-ico" style="margin-left:18px;">
      <span class="vcoins-solde">--</span>
    </div>
    <div class="section-label" data-i18n="boutique.section.vcoins"></div>
    <div class="achats-list" id="achats-list"></div>
    <div class="section-label" style="margin-top:1.5em;" data-i18n="boutique.section.themes"></div>
    <div class="themes-list" id="themes-list"></div>
  </div>

  <!-- MODAL -->
  <div class="modal-backdrop" id="themeModalBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="themeModalTitle">
      <div class="modal-header">
        <div id="themeModalTitle"></div>
        <button class="modal-close" id="themeModalClose" aria-label="Fermer">✕</button>
      </div>
      <div class="modal-body">
        <img id="themeModalImage" src="" alt="" />
      </div>
      <div class="modal-actions" id="themeModalActions"></div>
    </div>
  </div>

<script>
function t(key) { return window.i18nGet ? window.i18nGet(key) : key; }

const THEMES = [
  { key: "neon",   name: "Neon"   },
  { key: "bubble", name: "Bubble" },
  { key: "nature", name: "Nature" },
  { key: "nuit",   name: "Nuit"   },
  { key: "retro",  name: "Retro"  },
  { key: "vitraux", name: "Vitraux" },
  { key: "angelique",  name: "Angelique"  },
  { key: "luxury", name: "Luxury" },
  { key: "space",  name: "Space"  },
  { key: "cyber",  name: "Cyber"  }
];

const SPECIAL_CARTOUCHES = [
  { key: "boutique.cartouche.points3000", icon: '<img src="assets/images/vcoin.webp" alt="Points">', color: 'color-yellow', prix: "0,99€", amount: 3000 },
  { key: "boutique.cartouche.points10000", icon: '<img src="assets/images/vcoin.webp" alt="Points">', color: 'color-purple', prix: "1,99€", amount: 10000 },
  { key: 'boutique.cartouche.jetons12', icon: '<img src="assets/images/jeton.webp" alt="jeton">', color: 'color-blue' },
  { key: 'boutique.cartouche.jetons50', icon: '<img src="assets/images/jeton.webp" alt="jeton">', color: 'color-purple' },
  { key: 'boutique.cartouche.nopub', icon: '<img src="assets/images/ads.png" alt="No Ads">', color: 'color-yellow' },
  { key: 'boutique.cartouche.pub1jeton', icon: '<img src="assets/images/jeton.webp" alt="Pub">', color: 'color-green' },
  { key: 'boutique.cartouche.pub300points', icon: '<img src="assets/images/vcoin.webp" alt="Pub">', color: 'color-blue' }
];

const THEME_PRICE = 5000;
const THEME_COLOR = {
  neon: 'color-purple', bubble: 'color-blue', nature: 'color-green', nuit: 'color-yellow',
  retro: 'color-purple', vitraux: 'color-yellow', angelique: 'color-blue',
  luxury: 'color-purple', space: 'color-blue', cyber: 'color-green'
};

function renderAchats() {
  const $achatsList = document.getElementById('achats-list');
  $achatsList.innerHTML = SPECIAL_CARTOUCHES.map(c => `
    <div class="special-cartouche ${c.color}">
      <span class="theme-ico">${c.icon}</span>
      <span class="theme-label" data-i18n="${c.key}">${t(c.key)}</span>
      ${c.prix ? `<span class="prix-label">${c.prix}</span>` : ""}
    </div>
  `).join('');
}

async function renderThemes() {
  renderAchats();
  const unlocked = await userData.getUnlockedThemes?.() || [];
  const $themesList = document.getElementById('themes-list');
  $themesList.innerHTML = THEMES.map(theme => {
    const isUnlocked = unlocked.includes(theme.key);
    const color = THEME_COLOR[theme.key] || 'color-blue';
    const webp = `assets/modes/${theme.key}.webp`;
    return `
      <div class="special-cartouche theme-card ${color} ${isUnlocked ? "unlocked" : "locked"}"
           role="button" tabindex="0"
           data-theme="${theme.key}">
        <span class="theme-ico">
          <img src="${webp}" alt="${theme.name}" />
        </span>
        <span class="theme-label">${theme.name}</span>
        <span class="prix-label">${isUnlocked ? (t('boutique.modal.possede')||'Possédé') : (THEME_PRICE + ' VCoins')}</span>
      </div>
    `;
  }).join('');
  $themesList.querySelectorAll('.theme-card').forEach(card => {
    const open = () => openThemeModal(card.dataset.theme);
    card.addEventListener('click', open);
    card.addEventListener('keydown', e => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); open(); } });
  });
  const solde = await userData.getVCoins?.();
  document.querySelector('.vcoins-solde').textContent = typeof solde === "number" ? solde : "--";
  const soldeJetons = await userData.getJetons?.();
  document.querySelectorAll('.vcoins-solde')[1].textContent = typeof soldeJetons === "number" ? soldeJetons : "--";
}

const $backdrop = document.getElementById('themeModalBackdrop');
const $title    = document.getElementById('themeModalTitle');
const $img      = document.getElementById('themeModalImage');
const $actions  = document.getElementById('themeModalActions');
const $close    = document.getElementById('themeModalClose');

function openThemeModal(themeKey) {
  const specificKey = "boutique.modal.titre." + themeKey;
  const specific = t(specificKey);
  const base = t("boutique.modal.titre");
  $title.textContent = (specific !== specificKey ? specific : `${base} ${themeKey}`);
  const webp = `assets/modes/${themeKey}.webp`;
  const png  = `assets/modes/${themeKey}.png`;
  $img.src = webp;
  $img.alt = themeKey;
  $img.onerror = () => { if ($img.src.endsWith('.webp')) $img.src = png; };
  renderModalActions(themeKey);
  $backdrop.style.display = 'flex';
  $backdrop.setAttribute('aria-hidden', 'false');
  if (window.applyI18n && window.I18N_MAP) window.applyI18n(window.I18N_MAP);
}

function closeThemeModal() {
  $backdrop.style.display = 'none';
  $backdrop.setAttribute('aria-hidden', 'true');
}

async function renderModalActions(themeKey) {
  $actions.innerHTML = '';
  const unlocked = await userData.getUnlockedThemes?.() || [];
  const isUnlocked = unlocked.includes(themeKey);
  if (isUnlocked) {
    const badge = document.createElement('div');
    badge.className = 'badge';
    badge.setAttribute('data-i18n', 'boutique.modal.possede');
    badge.textContent = t('boutique.modal.possede');
    $actions.appendChild(badge);
  } else {
    const buy = document.createElement('button');
    buy.className = 'btn btn-primary';
    buy.setAttribute('data-i18n', 'boutique.modal.acheter');
    buy.textContent = (t('boutique.modal.acheter') || 'Acheter') + ` (${THEME_PRICE} VCoins)`;
    buy.onclick = async () => {
      const coins = await userData.getVCoins();
      if (coins < THEME_PRICE) { alert(t("boutique.alert.pasassez")); return; }
      await userData.addVCoins(-THEME_PRICE);
      await unlockThemeCloud(themeKey);
      await renderThemes();
      renderModalActions(themeKey);
      if (window.applyI18n && window.I18N_MAP) window.applyI18n(window.I18N_MAP);
    };
    $actions.appendChild(buy);
  }
  const closeBtn = document.createElement('button');
  closeBtn.className = 'btn btn-ghost';
  closeBtn.setAttribute('data-i18n', 'boutique.modal.fermer');
  closeBtn.textContent = t('boutique.modal.fermer') || 'Fermer';
  closeBtn.onclick = closeThemeModal;
  $actions.appendChild(closeBtn);
}

$close?.addEventListener('click', closeThemeModal);
$backdrop.addEventListener('click', e => { if (e.target === $backdrop) closeThemeModal(); });
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeThemeModal(); });

function ready(fn) {
  if (window.i18nReady && typeof window.i18nReady.then === "function") window.i18nReady.then(fn);
  else setTimeout(fn, 0);
}
ready(async () => {
  await renderThemes();
  if (window.applyI18n && window.I18N_MAP) window.applyI18n(window.I18N_MAP);
  if (window.i18nGet) document.title = window.i18nGet("boutique.titre") || "Boutique";
});
</script>
</body>
</html>
