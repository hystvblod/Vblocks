<!DOCTYPE html>
<html lang="fr">
<head>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.42.5/dist/umd/supabase.min.js"></script>
  <script src="js/userData.js"></script>
  <script src="js/i18n.js"></script>
  <meta charset="UTF-8">
  <title data-i18n="boutique.titre"></title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style/main.css">
  <style>
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
      height: 65px;
      z-index: 30;
      padding: 0 12px;
      box-sizing: border-box;
      background: none;
    }
    .top-left, .top-right {
      display: flex;
      align-items: center;
      min-width: 55px;
    }
    .top-center {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      pointer-events: none;
    }
    .shop-title {
      font-size: 1.5em;
      font-weight: bold;
      color: #fff;
      letter-spacing: 0.01em;
      text-shadow: 0 2px 12px #0004;
      pointer-events: none;
    }
    .container-boutique {
      max-width: 430px;
      margin: 0 auto;
      padding-top: 80px;
      box-sizing: border-box;
    }
    .vcoins-bar {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25em;
      margin: 1.2em 0 0.6em 0;
      background: #fff2;
      border-radius: 1em;
      padding: 0.6em 0;
      box-shadow: 0 2px 8px #0001;
    }
    .vcoin-ico {
      width: 28px;
      height: 28px;
      margin: 0 7px;
      vertical-align: middle;
    }
    .section-label {
      font-weight: 600;
      color: #3a3;
      font-size: 1.12em;
      margin-bottom: 0.4em;
      margin-top: 1.3em;
      letter-spacing: 0.01em;
    }
    .achats-list {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 14px;
    }
    .special-cartouche {
      display: flex;
      flex-direction: column;
      align-items: center;
      border-radius: 16px;
      background: #fff2;
      margin: 0.5em 0.6em;
      padding: 1em 0.7em 0.7em 0.7em;
      min-width: 120px;
      box-shadow: 0 2px 10px #0001;
      position: relative;
      transition: box-shadow 0.13s;
      cursor: pointer;
    }
    .special-cartouche:active {
      box-shadow: 0 4px 16px #0002;
      transform: scale(0.97);
    }
    .theme-ico { font-size: 2.1em; margin-bottom: 0.18em; }
    .theme-label { font-weight: 600; font-size: 1.06em; }
    .prix-label {
      margin-top: 0.3em;
      background: #fff9;
      color: #222;
      font-size: 1em;
      border-radius: 1em;
      padding: 0.12em 0.9em;
      font-weight: 600;
      box-shadow: 0 2px 6px #0001;
    }
    .color-yellow { background: linear-gradient(110deg, #ffe687bb 0%, #fffbe699 100%); }
    .color-purple { background: linear-gradient(110deg, #dab0fcbb 0%, #c3a5ff99 100%); }
    .color-blue   { background: linear-gradient(110deg, #91d7ffbb 0%, #d3f1ff99 100%); }
    .color-green  { background: linear-gradient(110deg, #c6ffe5bb 0%, #dcfffd99 100%); }
    /* Ajoute d'autres couleurs si besoin */
  </style>
</head>
<body>
  <div class="top-bar">
    <div class="top-left">
      <a href="index.html" class="btn-back" title="" tabindex="0" >
        <svg viewBox="0 0 36 36" fill="none">
          <path d="M23.5 28L15 19.5L23.5 11" stroke="#fff" stroke-width="3.2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </a>
    </div>
    <div class="top-center">
      <div class="shop-title" data-i18n="boutique.titre"></div>
    </div>
    <div class="top-right">
      <a href="profil.html" class="btn-icon" >
        <img src="assets/icons/user.svg" alt="Profil" />
      </a>
      <a href="parametres.html" class="btn-icon" title="" >
        <img src="assets/icons/settings.svg" alt="Paramètres" />
      </a>
    </div>
  </div>
  <div class="container-boutique">
    <div id="soldeVCoins" class="vcoins-bar">
      <img src="assets/images/vcoin.webp" alt="VCoins" class="vcoin-ico">
      <span class="vcoins-solde">--</span>
      <img src="assets/images/jeton.webp" alt="Jetons" class="vcoin-ico" style="margin-left:18px;">
      <span class="vcoins-solde">--</span>
    </div>
    <div class="section-label" data-i18n="boutique.section.vcoins"></div>
    <div class="achats-list" id="achats-list"></div>
    <div class="section-label" style="margin-top:1.5em;" data-i18n="boutique.section.themes"></div>
    <div class="themes-list" id="themes-list"></div>
  </div>
<script>
// --- Helper i18n ---
function t(key) { return window.i18nGet ? window.i18nGet(key) : key; }

// Thèmes dispo
const THEMES = [
  { key: "neon",   name: "Neon"   },
  { key: "bubble", name: "Bubble" },
  { key: "nature", name: "Nature" },
  { key: "nuit",   name: "Nuit"   },
  { key: "retro",  name: "Retro"  },
  { key: "vitraux", name: "Vitraux" },
  { key: "candy",  name: "Candy"  },
  { key: "luxury", name: "Luxury" },
  { key: "space",  name: "Space"  },
  { key: "cyber",  name: "Cyber"  }
];

// Cartouches d’achats spéciaux
const SPECIAL_CARTOUCHES = [
  {
    key: 'boutique.cartouche.points3000',
    icon: '<img src="assets/images/vcoin.webp" alt="Points">',
    color: 'color-yellow',
    prix: "0,99€",
    amount: 3000
  },
  {
    key: 'boutique.cartouche.points10000',
    icon: '<img src="assets/images/vcoin.webp" alt="Points">',
    color: 'color-purple',
    prix: "1,99€",
    amount: 10000
  },
  {
    key: 'boutique.cartouche.jetons12',
    icon: '<img src="assets/images/jeton.webp" alt="jeton">',
    color: 'color-blue'
  },
  {
    key: 'boutique.cartouche.jetons50',
    icon: '<img src="assets/images/jeton.webp" alt="jeton">',
    color: 'color-purple'
  },
  {
    key: 'boutique.cartouche.nopub',
    icon: '<img src="assets/images/ads.png" alt="No Ads">',
    color: 'color-yellow'
  },
  {
    key: 'boutique.cartouche.pub1jeton',
    icon: '<img src="assets/images/jeton.webp" alt="Pub">',
    color: 'color-green'
  },
  {
    key: 'boutique.cartouche.pub300points',
    icon: '<img src="assets/images/vcoin.webp" alt="Pub">',
    color: 'color-blue'
  }
];

const THEME_PRICE = 3000;

// --- Ajout thème cloud uniquement Supabase ---
async function unlockThemeCloud(themeKey) {
  const userId = window.getUserId();
  let { data, error } = await window.sb.from('users').select('themes_possedes').eq('id', userId).single();
  if (error) return false;
  let themes = Array.isArray(data?.themes_possedes) ? data.themes_possedes : [];
  if (!themes.includes(themeKey)) {
    themes.push(themeKey);
    await window.sb.from('users').update({ themes_possedes: themes }).eq('id', userId);
  }
  return true;
}

// Rendu principal
async function renderThemes() {
  // Récupère la liste cloud (Supabase only)
  const unlocked = await userData.getUnlockedThemes?.() || [];

  // Cartouches du haut
  const $achatsList = document.getElementById('achats-list');
  let achatsHtml = SPECIAL_CARTOUCHES.map(c => `
    <div class="special-cartouche ${c.color}">
      <span class="theme-ico">${c.icon}</span>
      <span class="theme-label" data-i18n="${c.key}">${t(c.key)}</span>
      ${c.prix ? `<span class="prix-label">${c.prix}</span>` : ""}
    </div>
  `).join('');
  $achatsList.innerHTML = achatsHtml;

  // Thèmes
  const $themesList = document.getElementById('themes-list');
  let html = THEMES.map(theme => {
    const isUnlocked = unlocked.includes(theme.key);
    return `
      <div class="theme-btn-style theme-${theme.key} ${isUnlocked ? "unlocked" : "locked"}">
        <span class="theme-label">${theme.name}</span>
        <span class="theme-action${isUnlocked ? " possede" : ""}" 
              ${isUnlocked ? "" : 'tabindex="0" role="button"'}
              data-theme="${theme.key}"
              data-i18n="${isUnlocked ? "theme.possede" : "theme.debloquer"}"
        >${t(isUnlocked ? "theme.possede" : "theme.debloquer")}</span>
      </div>
    `;
  }).join('');
  $themesList.innerHTML = html;

  // Débloquer
  $themesList.querySelectorAll('.theme-action:not(.possede)').forEach(btn => {
    btn.onclick = async (e) => {
      e.stopPropagation();
      const key = btn.dataset.theme;
      const coins = await userData.getVCoins();
      if (coins < THEME_PRICE) {
        alert(t("boutique.alert.pasassez"));
        return;
      }
      await userData.addVCoins(-THEME_PRICE);
      await unlockThemeCloud(key);
      await renderThemes();
      setupPubCartouches();
      setupBoutiqueAchats();
      if (window.applyI18n && window.I18N_MAP) window.applyI18n(window.I18N_MAP);
    }
  });

  // Solde
  const solde = await userData.getVCoins?.();
  document.querySelector('.vcoins-solde').textContent = typeof solde === "number" ? solde : "--";
  const soldeJetons = await userData.getJetons?.();
  document.querySelectorAll('.vcoins-solde')[1].textContent = typeof soldeJetons === "number" ? soldeJetons : "--";
}

// Cartouches pub
function setupPubCartouches() {
  document.querySelectorAll('.special-cartouche').forEach(cartouche => {
    const label = cartouche.querySelector('.theme-label');
    if (!label) return;
    const key = label.dataset.i18n;
    if (key === 'boutique.cartouche.pub1jeton') {
      cartouche.style.cursor = 'pointer';
      cartouche.onclick = async () => {
        cartouche.onclick = null;
        showRewarded(async (ok) => {
          if (ok && window.userData && userData.addJetons) {
            try {
              await userData.addJetons(REWARD_JETONS);
              alert("+1 jeton ajouté !");
              await renderThemes();
              setupPubCartouches();
              setupBoutiqueAchats();
              if (window.applyI18n && window.I18N_MAP) window.applyI18n(window.I18N_MAP);
            } catch(e) {
              alert("Erreur : " + (e?.message || e));
            }
          }
        });
      };
    }
    if (key === 'boutique.cartouche.pub300points') {
      cartouche.style.cursor = 'pointer';
      cartouche.onclick = async () => {
        cartouche.onclick = null;
        showRewarded(async (ok) => {
          if (ok && window.userData && userData.addVCoins) {
            try {
              await userData.addVCoins(300);
              alert("+300 VCoins ajoutés !");
              await renderThemes();
              setupPubCartouches();
              setupBoutiqueAchats();
              if (window.applyI18n && window.I18N_MAP) window.applyI18n(window.I18N_MAP);
            } catch(e) {
              alert("Erreur : " + (e?.message || e));
            }
          }
        });
      };
    }
  });
}

// Brancher les achats monétaires (points, jetons12, jetons50, nopub)
function setupBoutiqueAchats() {
  document.querySelectorAll('.special-cartouche').forEach(cartouche => {
    const label = cartouche.querySelector('.theme-label');
    if (!label) return;
    const key = label.dataset.i18n;

    // Points 3000
    if (key === 'boutique.cartouche.points3000') {
      cartouche.style.cursor = 'pointer';
      cartouche.onclick = async () => {
        if (await lancerPaiement("points3000")) {
          await userData.addVCoins(3000);
          alert("+3000 points ajoutés !");
          await renderThemes();
          setupPubCartouches();
          setupBoutiqueAchats();
          if (window.applyI18n && window.I18N_MAP) window.applyI18n(window.I18N_MAP);
        }
      };
    }
    // Points 10000
    if (key === 'boutique.cartouche.points10000') {
      cartouche.style.cursor = 'pointer';
      cartouche.onclick = async () => {
        if (await lancerPaiement("points10000")) {
          await userData.addVCoins(10000);
          alert("+10 000 points ajoutés !");
          await renderThemes();
          setupPubCartouches();
          setupBoutiqueAchats();
          if (window.applyI18n && window.I18N_MAP) window.applyI18n(window.I18N_MAP);
        }
      };
    }
    if (key === 'boutique.cartouche.jetons12') {
      cartouche.style.cursor = 'pointer';
      cartouche.onclick = async () => {
        if (await lancerPaiement("jetons12")) {
          accordeAchat("jetons12");
        }
      };
    }
    if (key === 'boutique.cartouche.jetons50') {
      cartouche.style.cursor = 'pointer';
      cartouche.onclick = async () => {
        if (await lancerPaiement("jetons50")) {
          accordeAchat("jetons50");
        }
      };
    }
    if (key === 'boutique.cartouche.nopub') {
      cartouche.style.cursor = 'pointer';
      cartouche.onclick = async () => {
        if (await lancerPaiement("nopub")) {
          accordeAchat("nopub");
        }
      };
    }
    // Les PUB sont gérées dans setupPubCartouches, ne pas dupliquer
  });
}

// --- INITIALISATION ---
function ready(fn) {
  if (window.i18nReady && typeof window.i18nReady.then === "function") {
    window.i18nReady.then(fn);
  } else {
    setTimeout(fn, 0);
  }
}
ready(async () => {
  await renderThemes();
  setupPubCartouches();
  setupBoutiqueAchats();
  if (window.applyI18n && window.I18N_MAP) window.applyI18n(window.I18N_MAP);
  if (window.i18nGet) document.title = window.i18nGet("boutique.titre") || "Boutique";
});
</script>
</body>
</html>
