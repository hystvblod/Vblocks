<!DOCTYPE html>
<html lang="fr">
<head>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.42.5/dist/umd/supabase.min.js"></script>
  <script src="js/userData.js"></script>
  <script src="js/i18n.js"></script>
  <meta charset="UTF-8">
  <title data-i18n="boutique.titre"></title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="style/main.css">
  <style>
    /* Scroll autorisé */
    html, body { height:auto; min-height:100%; overflow:auto; }
    body { overscroll-behavior-y:auto; }

    .container-boutique { padding-bottom: 80px; }

    /* Grilles: 2 par ligne */
    .achats-list, .themes-list {
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 14px;
    }
    .themes-list { margin-top: .5rem; }

    /* Cartouches de thèmes (même style que haut) */
    .theme-card.special-cartouche {
      cursor: pointer;
      transition: transform .06s ease, box-shadow .2s ease;
      user-select: none;
      align-items: center;
      justify-content: space-between;
    }
    .theme-card.special-cartouche:hover { transform: translateY(-1px); }

    /* Icône/image dans cartouche — MASQUÉ pour les thèmes */
    .theme-card .theme-ico{ display: none !important; }

    /* Texte en BLANC pour les thèmes */
    .theme-card .theme-label,
    .theme-card .prix-label { color: #fff !important; }

    .theme-card .theme-label{ font-weight: 700; letter-spacing: .2px; }

    .theme-card.unlocked { opacity: 1; }
    .theme-card.locked   { opacity: .95; }

    /* Prix en blanc pour toutes les cartouches d'achats (hors thèmes) */
    .achats-list .prix-label { color:#fff; font-weight:700; }

    /* Modal */
    .modal-backdrop {
      position: fixed; inset: 0;
      background: rgba(0,0,0,.58);
      display: none;
      align-items: center; justify-content: center;
      z-index: 9999;
      backdrop-filter: blur(2px);
    }
    .modal {
      width: min(520px, 92vw);
      border-radius: 16px;
      background: var(--card-bg, #17181c);
      color: var(--body-color, #e9e9e9);
      border: 1px solid rgba(255,255,255,0.08);
      box-shadow: 0 12px 40px rgba(0,0,0,.4);
      overflow: hidden;
    }
    .modal-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      font-weight: 700;
    }
    .modal-body { padding: 14px 16px 4px 16px; text-align: center; }
    .modal-body img {
      width: 100%; height: auto; border-radius: 12px;
      background: rgba(255,255,255,0.03);
    }
    .modal-actions {
      display: flex; gap: 10px; justify-content: center; align-items: center;
      padding: 16px;
    }
    .btn { appearance: none; border: 0; border-radius: 12px; padding: 12px 16px; font-weight: 700; cursor: pointer; }
    .btn-primary { background: linear-gradient(135deg, #5c8df7, #7a5cf7); color: #fff; }
    .btn-ghost { background: transparent; color: #ddd; border: 1px solid rgba(255,255,255,.15); }
    .badge {
      display: inline-flex; align-items: center; justify-content: center;
      padding: 10px 14px; border-radius: 999px;
      background: rgba(255,255,255,.08); color: #ddd; font-weight: 700;
      border: 1px solid rgba(255,255,255,.12);
    }
    .modal-close { background: transparent; border: 0; color: #bbb; cursor: pointer; padding: 8px; border-radius: 10px; }
    .modal-close:hover { background: rgba(255,255,255,.06); }
  </style>
</head>
<body>
  <div class="top-bar">
    <div class="top-left">
      <a href="index.html" class="btn-back" title="" tabindex="0">
        <svg viewBox="0 0 36 36" fill="none">
          <path d="M23.5 28L15 19.5L23.5 11" stroke="#fff" stroke-width="3.2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </a>
    </div>
    <div class="top-right">
      <a href="profil.html" class="btn-icon">
        <img src="assets/icons/user.svg" alt="Profil" />
      </a>
      <a href="parametres.html" class="btn-icon">
        <img src="assets/icons/settings.svg" alt="Paramètres" />
      </a>
    </div>
  </div>

  <div class="container-boutique">
    <div class="shop-title" data-i18n="boutique.titre"></div>

    <div id="soldeVCoins" class="vcoins-bar">
      <img src="assets/images/vcoin.webp" alt="VCoins" class="vcoin-ico">
      <span class="vcoins-solde">--</span>
      <img src="assets/images/jeton.webp" alt="Jetons" class="vcoin-ico" style="margin-left:18px;">
      <span class="vcoins-solde">--</span>
    </div>

    <div class="section-label" data-i18n="boutique.section.vcoins"></div>
    <div class="achats-list" id="achats-list"></div>

    <div class="section-label" style="margin-top:1.5em;" data-i18n="boutique.section.themes"></div>
    <div class="themes-list" id="themes-list"></div>
  </div>

  <!-- MODAL -->
  <div class="modal-backdrop" id="themeModalBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="themeModalTitle">
      <div class="modal-header">
        <div id="themeModalTitle"></div>
        <button class="modal-close" id="themeModalClose" aria-label="Fermer">✕</button>
      </div>
      <div class="modal-body">
        <img id="themeModalImage" src="" alt="" />
      </div>
      <div class="modal-actions" id="themeModalActions"></div>
    </div>
  </div>

<script>
/* ===== Helpers i18n ===== */
function t(key) { return window.i18nGet ? window.i18nGet(key) : key; }

/* ===== Données ===== */
const THEMES = [
  { key: "neon",   name: "Neon"   },
  { key: "bubble", name: "Bubble" },
  { key: "nature", name: "Nature" },
  { key: "nuit",   name: "Nuit"   },
  { key: "retro",  name: "Retro"  },
  { key: "vitraux", name: "Vitraux" },
  { key: "angelique",  name: "Angelique"  },
  { key: "luxury", name: "Luxury" },
  { key: "space",  name: "Space"  },
  { key: "cyber",  name: "Cyber"  }
];

/* Chaque cartouche a maintenant un productId (même ID que sur Google/Apple) */
const SPECIAL_CARTOUCHES = [
  { key: "boutique.cartouche.points3000",  productId:"points3000",  icon:'<img src="assets/images/vcoin.webp" alt="Points">', color:'color-yellow', prix:null, amount:3000 },
  { key: "boutique.cartouche.points10000", productId:"points10000", icon:'<img src="assets/images/vcoin.webp" alt="Points">', color:'color-purple', prix:null, amount:10000 },
  { key: "boutique.cartouche.jetons12",    productId:"jetons12",    icon:'<img src="assets/images/jeton.webp" alt="jeton">', color:'color-blue',   prix:null, amount:12 },
  { key: "boutique.cartouche.jetons50",    productId:"jetons50",    icon:'<img src="assets/images/jeton.webp" alt="jeton">', color:'color-purple', prix:null, amount:50 },
  { key: "boutique.cartouche.nopub",       productId:"nopub",       icon:'<img src="assets/images/ads.png" alt="No Ads">',   color:'color-yellow', prix:null },
  { key: "boutique.cartouche.pub1jeton",   productId:null,          icon:'<img src="assets/images/jeton.webp" alt="Pub">',   color:'color-green' },
  { key: "boutique.cartouche.pub300points",productId:null,          icon:'<img src="assets/images/vcoin.webp" alt="Pub">',   color:'color-blue' }
];

const THEME_PRICE = 5000;
/* Valeur par défaut si non définie ailleurs */
const REWARD_JETONS = typeof window.REWARD_JETONS === 'number' ? window.REWARD_JETONS : 1;

/* Couleurs cartouches (thèmes) */
const THEME_COLOR = {
  neon: 'color-purple',
  bubble: 'color-blue',
  nature: 'color-green',
  nuit: 'color-yellow',
  retro: 'color-purple',
  vitraux: 'color-yellow',
  angelique: 'color-blue',
  luxury: 'color-purple',
  space: 'color-blue',
  cyber: 'color-green'
};

/* ===== Cloud unlock (optionnel) ===== */
async function unlockThemeCloud(themeKey) {
  const userId = window.getUserId ? window.getUserId() : (window.userData?.getUserId?.() || "");
  const sb = window.sb || window.supabaseClient || window.userData?.sb || window.supabase;
  if (!sb || !userId) return true;

  const { data, error } = await sb.from('users').select('themes_possedes').eq('id', userId).single();
  if (error) return false;
  let themes = Array.isArray(data?.themes_possedes) ? data.themes_possedes : [];
  if (!themes.includes(themeKey)) {
    themes.push(themeKey);
    await sb.from('users').update({ themes_possedes: themes }).eq('id', userId);
  }
  return true;
}

/* ========= Store Bridge (fallback web) =========
   ➜ Sur Capacitor, on remplacera getStoreProducts() pour renvoyer les prix du store */
async function getStoreProducts(productIds){
  // Fallback DEV (web). On branchera Capacitor après.
  const fallback = {
    points3000:  "€0,99",
    points10000: "€1,99",
    jetons12:    "€0,99",
    jetons50:    "€2,99",
    nopub:       "€3,49",
  };
  return productIds.reduce((acc,id)=>{ if(id) acc[id]={id, price: fallback[id]||"—"}; return acc; },{});
}

/* ===== Rendus ===== */
async function renderAchats() {
  const $achatsList = document.getElementById('achats-list');

  // 1) construire le DOM
  $achatsList.innerHTML = SPECIAL_CARTOUCHES.map(c => `
    <div class="special-cartouche ${c.color}" ${c.productId ? `data-product-id="${c.productId}"` : ""}>
      <span class="theme-ico">${c.icon}</span>
      <span class="theme-label" data-i18n="${c.key}">${t(c.key)}</span>
      <span class="prix-label">${c.prix ?? "…"}</span>
    </div>
  `).join('');

  // 2) récupérer les prix locaux depuis le store (ou fallback)
  const ids = SPECIAL_CARTOUCHES.map(c => c.productId).filter(Boolean);
  const products = await getStoreProducts(ids); // {points3000:{price:"$0.99"}, ...}

  // 3) injecter les prix (en blanc via CSS)
  document.querySelectorAll('#achats-list .special-cartouche').forEach(node=>{
    const id = node.getAttribute('data-product-id');
    const priceNode = node.querySelector('.prix-label');
    if (id && products[id]?.price && priceNode) {
      priceNode.textContent = products[id].price; // ex: "$0.99", "1,99 €"
    }
  });
}

/* Liste thèmes: SANS photo (pas d'icône), texte blanc, WEBP only en popup */
async function renderThemes() {
  await renderAchats();

  const unlocked = await (window.userData?.getUnlockedThemes?.() || []);
  const $themesList = document.getElementById('themes-list');

  const html = THEMES.map(theme => {
    const isUnlocked = unlocked.includes(theme.key);
    const color = THEME_COLOR[theme.key] || 'color-blue';
    return `
      <div class="special-cartouche theme-card ${color} ${isUnlocked ? "unlocked" : "locked"}"
           role="button" tabindex="0"
           data-theme="${theme.key}">
        <span class="theme-label">${theme.name}</span>
        <span class="prix-label">${isUnlocked ? (t('boutique.modal.possede') || 'Possédé') : (THEME_PRICE + ' VCoins')}</span>
      </div>
    `;
  }).join('');
  $themesList.innerHTML = html;

  // Rebranche les clics à chaque rendu
  setupBoutiqueAchats();
  setupPubCartouches();

  // Ouvrir popup
  $themesList.querySelectorAll('.theme-card').forEach(card => {
    const open = () => openThemeModal(card.dataset.theme);
    card.addEventListener('click', open);
    card.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); open(); } });
  });

  // Soldes
  const coins = await window.userData?.getVCoins?.();
  const $soldeCoins = document.querySelector('.vcoins-solde');
  if ($soldeCoins) $soldeCoins.textContent = (typeof coins === "number" ? coins : "--");

  const jetons = await window.userData?.getJetons?.();
  const $soldeJetons = document.querySelectorAll('.vcoins-solde')[1];
  if ($soldeJetons) $soldeJetons.textContent = (typeof jetons === "number" ? jetons : "--");
}

/* Pub (récompenses) — on ne cible que la liste achats */
function setupPubCartouches() {
  document.querySelectorAll('#achats-list .special-cartouche').forEach(cartouche => {
    const label = cartouche.querySelector('.theme-label');
    if (!label) return;
    const key = label.dataset.i18n;

    if (key === 'boutique.cartouche.pub1jeton') {
      cartouche.style.cursor = 'pointer';
      cartouche.onclick = async () => {
        cartouche.onclick = null;
        try {
          await window.userData?.addJetons?.(REWARD_JETONS);
          alert("+1 jeton ajouté !");
          await renderThemes();
        } catch(e) {
          alert("Erreur : " + (e?.message || e));
        }
      };
    }

    if (key === 'boutique.cartouche.pub300points') {
      cartouche.style.cursor = 'pointer';
      cartouche.onclick = async () => {
        cartouche.onclick = null;
        try {
          await window.userData?.addVCoins?.(300);
          alert("+300 VCoins ajoutés !");
          await renderThemes();
        } catch(e) {
          alert("Erreur : " + (e?.message || e));
        }
      };
    }
  });
}

/* Achats € — on ne cible que la liste achats */
function setupBoutiqueAchats() {
  document.querySelectorAll('#achats-list .special-cartouche').forEach(cartouche => {
    const label = cartouche.querySelector('.theme-label');
    if (!label) return;
    const key = label.dataset.i18n;

    // ➜ NOUVEAU : rendre cliquables points3000 / points10000
    if (key === 'boutique.cartouche.points3000') {
      cartouche.style.cursor = 'pointer';
      cartouche.onclick = async () => {
        if (await window.lancerPaiement?.("points3000")) window.accordeAchat?.("points3000");
      };
    }
    if (key === 'boutique.cartouche.points10000') {
      cartouche.style.cursor = 'pointer';
      cartouche.onclick = async () => {
        if (await window.lancerPaiement?.("points10000")) window.accordeAchat?.("points10000");
      };
    }

    // déjà présents
    if (key === 'boutique.cartouche.jetons12') {
      cartouche.style.cursor = 'pointer';
      cartouche.onclick = async () => {
        if (await window.lancerPaiement?.("jetons12")) window.accordeAchat?.("jetons12");
      };
    }
    if (key === 'boutique.cartouche.jetons50') {
      cartouche.style.cursor = 'pointer';
      cartouche.onclick = async () => {
        if (await window.lancerPaiement?.("jetons50")) window.accordeAchat?.("jetons50");
      };
    }
    if (key === 'boutique.cartouche.nopub') {
      cartouche.style.cursor = 'pointer';
      cartouche.onclick = async () => {
        if (await window.lancerPaiement?.("nopub")) window.accordeAchat?.("nopub");
      };
    }
  });
}

/* ===== Popup thème ===== */
const $backdrop = document.getElementById('themeModalBackdrop');
const $title    = document.getElementById('themeModalTitle');
const $img      = document.getElementById('themeModalImage');
const $actions  = document.getElementById('themeModalActions');
const $close    = document.getElementById('themeModalClose');

function openThemeModal(themeKey) {
  // Titre i18n (spécifique -> sinon "Aperçu du thème <key>")
  const specificKey = "boutique.modal.titre." + themeKey;
  const specific = t(specificKey);
  const base = t("boutique.modal.titre");
  $title.textContent = (specific !== specificKey ? specific : `${base} ${themeKey}`);

  // Image avec fallback PNG UNIQUEMENT dans la popup
  const webp = `assets/modes/${themeKey}.webp`;
  const png  = `assets/modes/${themeKey}.png`;
  $img.src = webp;
  $img.alt = themeKey;
  $img.onerror = () => { if ($img.src.endsWith('.webp')) $img.src = png; };

  renderModalActions(themeKey);

  $backdrop.style.display = 'flex';
  $backdrop.setAttribute('aria-hidden', 'false');

  if (window.applyI18n && window.I18N_MAP) window.applyI18n(window.I18N_MAP);
}

function closeThemeModal() {
  $backdrop.style.display = 'none';
  $backdrop.setAttribute('aria-hidden', 'true');
}

async function renderModalActions(themeKey) {
  $actions.innerHTML = '';
  const unlocked = await (window.userData?.getUnlockedThemes?.() || []);
  const isUnlocked = unlocked.includes(themeKey);

  if (isUnlocked) {
    const badge = document.createElement('div');
    badge.className = 'badge';
    badge.setAttribute('data-i18n', 'boutique.modal.possede');
    badge.textContent = t('boutique.modal.possede');
    $actions.appendChild(badge);
  } else {
    const buy = document.createElement('button');
    buy.className = 'btn btn-primary';
    buy.setAttribute('data-i18n', 'boutique.modal.acheter');
    buy.textContent = (t('boutique.modal.acheter') || 'Acheter') + ` (${THEME_PRICE} VCoins)`;
    buy.onclick = async () => {
      const coins = await window.userData?.getVCoins?.();
      if (coins < THEME_PRICE) { alert(t("boutique.alert.pasassez")); return; }
      await window.userData.addVCoins(-THEME_PRICE);
      await unlockThemeCloud(themeKey);
      await renderThemes();      // refresh listes + soldes
      renderModalActions(themeKey); // transforme en "Possédé"
      if (window.applyI18n && window.I18N_MAP) window.applyI18n(window.I18N_MAP);
    };
    $actions.appendChild(buy);
  }

  const closeBtn = document.createElement('button');
  closeBtn.className = 'btn btn-ghost';
  closeBtn.setAttribute('data-i18n', 'boutique.modal.fermer');
  closeBtn.textContent = t('boutique.modal.fermer') || 'Fermer';
  closeBtn.onclick = closeThemeModal;
  $actions.appendChild(closeBtn);
}

/* ===== Init ===== */
$close?.addEventListener('click', closeThemeModal);
$backdrop.addEventListener('click', (e) => { if (e.target === $backdrop) closeThemeModal(); });
document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeThemeModal(); });

function ready(fn) {
  if (window.i18nReady && typeof window.i18nReady.then === "function") window.i18nReady.then(fn);
  else setTimeout(fn, 0);
}
ready(async () => {
  await renderThemes();           // => renderAchats() inclus
  // i18n global après génération dynamique
  if (window.applyI18n && window.I18N_MAP) window.applyI18n(window.I18N_MAP);
  if (window.i18nGet) document.title = window.i18nGet("boutique.titre") || "Boutique";
});
</script>
</body>
</html>
