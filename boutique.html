<!DOCTYPE html>
<html lang="fr">
<head>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.42.5/dist/umd/supabase.min.js"></script>
  <script src="js/userData.js"></script>
  <script src="js/i18n.js"></script>
  <meta charset="UTF-8">
  <title data-i18n="boutique.titre"></title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="style/main.css">
  <style>
    /* === Overrides: activer le scroll global === */
    html, body { height:auto; min-height:100%; overflow:auto; }
    body { overscroll-behavior-y:auto; }

    /* Conteneur boutique scrollable si besoin */
    .container-boutique {
      padding-bottom: 80px;
    }

    /* Cartes thèmes (réutilise ton markup existant) */
    .themes-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 14px;
      margin-top: .5rem;
    }
    .theme-btn-style {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 14px 16px;
      border-radius: 14px;
      background: var(--card-bg, rgba(255,255,255,0.05));
      border: 1px solid rgba(255,255,255,0.08);
      cursor: pointer;
      transition: transform .06s ease, box-shadow .2s ease;
      user-select: none;
    }
    .theme-btn-style:hover { transform: translateY(-1px); }
    .theme-btn-style .theme-label { font-weight: 600; }

    /* Suppression visuelle des anciens badges/boutons (on ne les génère plus) */
    .theme-action { display:none !important; }

    /* --- Modal --- */
    .modal-backdrop {
      position: fixed; inset: 0;
      background: rgba(0,0,0,.58);
      display: none; /* toggled */
      align-items: center; justify-content: center;
      z-index: 9999;
      backdrop-filter: blur(2px);
    }
    .modal {
      width: min(520px, 92vw);
      border-radius: 16px;
      background: var(--card-bg, #17181c);
      color: var(--body-color, #e9e9e9);
      border: 1px solid rgba(255,255,255,0.08);
      box-shadow: 0 12px 40px rgba(0,0,0,.4);
      overflow: hidden;
    }
    .modal-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      font-weight: 700;
    }
    .modal-body {
      padding: 14px 16px 4px 16px;
      text-align: center;
    }
    .modal-body img {
      width: 100%; height: auto; border-radius: 12px;
      background: rgba(255,255,255,0.03);
    }
    .modal-actions {
      display: flex; gap: 10px; justify-content: center; align-items: center;
      padding: 16px;
    }
    .btn {
      appearance: none; border: 0; border-radius: 12px;
      padding: 12px 16px; font-weight: 700; cursor: pointer;
    }
    .btn-primary {
      background: linear-gradient(135deg, #5c8df7, #7a5cf7);
      color: #fff;
    }
    .btn-ghost {
      background: transparent; color: #ddd;
      border: 1px solid rgba(255,255,255,.15);
    }
    .badge {
      display: inline-flex; align-items: center; justify-content: center;
      padding: 10px 14px; border-radius: 999px;
      background: rgba(255,255,255,.08); color: #ddd; font-weight: 700;
      border: 1px solid rgba(255,255,255,.12);
    }
    .modal-close {
      background: transparent; border: 0; color: #bbb; cursor: pointer;
      padding: 8px; border-radius: 10px;
    }
    .modal-close:hover { background: rgba(255,255,255,.06); }
  </style>
</head>
<body>
  <div class="top-bar">
    <div class="top-left">
      <a href="index.html" class="btn-back" title="" tabindex="0" >
        <svg viewBox="0 0 36 36" fill="none">
          <path d="M23.5 28L15 19.5L23.5 11" stroke="#fff" stroke-width="3.2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </a>
    </div>
    <div class="top-right">
      <a href="profil.html" class="btn-icon" >
        <img src="assets/icons/user.svg" alt="Profil" />
      </a>
      <a href="parametres.html" class="btn-icon" title="" >
        <img src="assets/icons/settings.svg" alt="Paramètres" />
      </a>
    </div>
  </div>

  <div class="container-boutique">
    <div class="shop-title" data-i18n="boutique.titre"></div>

    <div id="soldeVCoins" class="vcoins-bar">
      <img src="assets/images/vcoin.webp" alt="VCoins" class="vcoin-ico">
      <span class="vcoins-solde">--</span>
      <img src="assets/images/jeton.webp" alt="Jetons" class="vcoin-ico" style="margin-left:18px;">
      <span class="vcoins-solde">--</span>
    </div>

    <div class="section-label" data-i18n="boutique.section.vcoins"></div>
    <div class="achats-list" id="achats-list"></div>

    <div class="section-label" style="margin-top:1.5em;" data-i18n="boutique.section.themes"></div>
    <div class="themes-list" id="themes-list"></div>
  </div>

  <!-- === MODAL === -->
  <div class="modal-backdrop" id="themeModalBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="themeModalTitle">
      <div class="modal-header">
        <div id="themeModalTitle"></div>
        <button class="modal-close" id="themeModalClose" aria-label="Fermer">
          ✕
        </button>
      </div>
      <div class="modal-body">
        <img id="themeModalImage" src="" alt="" />
      </div>
      <div class="modal-actions" id="themeModalActions">
        <!-- Boutons injectés dynamiquement -->
      </div>
    </div>
  </div>

<script>
/** i18n helper */
function t(key) { return window.i18nGet ? window.i18nGet(key) : key; }

/** Thèmes disponibles (mêmes clés que ton fichier actuel) */
const THEMES = [
  { key: "neon",   name: "Neon"   },
  { key: "bubble", name: "Bubble" },
  { key: "nature", name: "Nature" },
  { key: "nuit",   name: "Nuit"   },
  { key: "retro",  name: "Retro"  },
  { key: "vitraux", name: "Vitraux" },
  { key: "angelique",  name: "Angelique"  },
  { key: "luxury", name: "Luxury" },
  { key: "space",  name: "Space"  },
  { key: "cyber",  name: "Cyber"  }
];

/** Cartouches existantes (inchangé) */
const SPECIAL_CARTOUCHES = [
  { key: "boutique.cartouche.points3000", icon: '<img src="assets/images/vcoin.webp" alt="Points">', color: 'color-yellow', prix: "0,99€", amount: 3000 },
  { key: "boutique.cartouche.points10000", icon: '<img src="assets/images/vcoin.webp" alt="Points">', color: 'color-purple', prix: "1,99€", amount: 10000 },
  { key: 'boutique.cartouche.jetons12', icon: '<img src="assets/images/jeton.webp" alt="jeton">', color: 'color-blue' },
  { key: 'boutique.cartouche.jetons50', icon: '<img src="assets/images/jeton.webp" alt="jeton">', color: 'color-purple' },
  { key: 'boutique.cartouche.nopub', icon: '<img src="assets/images/ads.png" alt="No Ads">', color: 'color-yellow' },
  { key: 'boutique.cartouche.pub1jeton', icon: '<img src="assets/images/jeton.webp" alt="Pub">', color: 'color-green' },
  { key: 'boutique.cartouche.pub300points', icon: '<img src="assets/images/vcoin.webp" alt="Pub">', color: 'color-blue' }
];

const THEME_PRICE = 5000;

/** Débloque côté cloud (Supabase) – même logique que ton fichier actuel */
async function unlockThemeCloud(themeKey) {
  const userId = window.getUserId ? window.getUserId() : (window.userData?.getUserId?.() || "");
  let { data, error } = await window.sb.from('users').select('themes_possedes').eq('id', userId).single();
  if (error) return false;
  let themes = Array.isArray(data?.themes_possedes) ? data.themes_possedes : [];
  if (!themes.includes(themeKey)) {
    themes.push(themeKey);
    await window.sb.from('users').update({ themes_possedes: themes }).eq('id', userId);
  }
  return true;
}

/** Rendu des cartouches */
function renderAchats() {
  const $achatsList = document.getElementById('achats-list');
  let achatsHtml = SPECIAL_CARTOUCHES.map(c => `
    <div class="special-cartouche ${c.color}">
      <span class="theme-ico">${c.icon}</span>
      <span class="theme-label" data-i18n="${c.key}">${t(c.key)}</span>
      ${c.prix ? `<span class="prix-label">${c.prix}</span>` : ""}
    </div>
  `).join('');
  $achatsList.innerHTML = achatsHtml;
}

/** Rendu des thèmes (sans bouton – clic ouvre modal) */
async function renderThemes() {
  renderAchats();

  const unlocked = await userData.getUnlockedThemes?.() || [];
  const $themesList = document.getElementById('themes-list');
  $themesList.innerHTML = THEMES.map(theme => {
    const isUnlocked = unlocked.includes(theme.key);
    return `
      <div class="theme-btn-style theme-${theme.key} ${isUnlocked ? "unlocked" : "locked"}"
           role="button" tabindex="0"
           data-theme="${theme.key}">
        <span class="theme-label">${theme.name}</span>
      </div>
    `;
  }).join('');

  // Binding: ouvrir la modal
  $themesList.querySelectorAll('.theme-btn-style').forEach(card => {
    card.addEventListener('click', () => {
      const key = card.dataset.theme;
      openThemeModal(key);
    });
    card.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        openThemeModal(card.dataset.theme);
      }
    });
  });

  // Soldes
  const solde = await userData.getVCoins?.();
  document.querySelector('.vcoins-solde').textContent = (typeof solde === "number" ? solde : "--");
  const soldeJetons = await userData.getJetons?.();
  document.querySelectorAll('.vcoins-solde')[1].textContent = (typeof soldeJetons === "number" ? soldeJetons : "--");
}

/** Cartouches pub/paiements (reprend ta logique) */
function setupPubCartouches() {
  document.querySelectorAll('.special-cartouche').forEach(cartouche => {
    const label = cartouche.querySelector('.theme-label');
    if (!label) return;
    const key = label.dataset.i18n;

    if (key === 'boutique.cartouche.pub1jeton') {
      cartouche.style.cursor = 'pointer';
      cartouche.onclick = async () => {
        cartouche.onclick = null;
        showRewarded(async (ok) => {
          if (ok && window.userData?.addJetons) {
            try {
              await userData.addJetons(REWARD_JETONS);
              alert("+1 jeton ajouté !");
              await renderThemes();
              setupPubCartouches();
              setupBoutiqueAchats();
              if (window.applyI18n && window.I18N_MAP) window.applyI18n(window.I18N_MAP);
            } catch(e) { alert("Erreur : " + (e?.message || e)); }
          }
        });
      };
    }
    if (key === 'boutique.cartouche.pub300points') {
      cartouche.style.cursor = 'pointer';
      cartouche.onclick = async () => {
        cartouche.onclick = null;
        showRewarded(async (ok) => {
          if (ok && window.userData?.addVCoins) {
            try {
              await userData.addVCoins(300);
              alert("+300 VCoins ajoutés !");
              await renderThemes(); setupPubCartouches(); setupBoutiqueAchats();
              if (window.applyI18n && window.I18N_MAP) window.applyI18n(window.I18N_MAP);
            } catch(e) { alert("Erreur : " + (e?.message || e)); }
          }
        });
      };
    }
  });
}

/** Branche achats € (inchangé) */
function setupBoutiqueAchats() {
  document.querySelectorAll('.special-cartouche').forEach(cartouche => {
    const label = cartouche.querySelector('.theme-label');
    if (!label) return;
    const key = label.dataset.i18n;

    if (key === 'boutique.cartouche.jetons12') {
      cartouche.style.cursor = 'pointer';
      cartouche.onclick = async () => {
        if (await lancerPaiement("jetons12")) accordeAchat("jetons12");
      };
    }
    if (key === 'boutique.cartouche.jetons50') {
      cartouche.style.cursor = 'pointer';
      cartouche.onclick = async () => {
        if (await lancerPaiement("jetons50")) accordeAchat("jetons50");
      };
    }
    if (key === 'boutique.cartouche.nopub') {
      cartouche.style.cursor = 'pointer';
      cartouche.onclick = async () => {
        if (await lancerPaiement("nopub")) accordeAchat("nopub");
      };
    }
  });
}

/** === MODAL LOGIC === */
const $backdrop = document.getElementById('themeModalBackdrop');
const $title    = document.getElementById('themeModalTitle');
const $img      = document.getElementById('themeModalImage');
const $actions  = document.getElementById('themeModalActions');
const $close    = document.getElementById('themeModalClose');

$close.addEventListener('click', closeThemeModal);
$backdrop.addEventListener('click', (e) => { if (e.target === $backdrop) closeThemeModal(); });
document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeThemeModal(); });

function openThemeModal(themeKey) {
  // Titre i18n configurable
  $title.textContent = t("boutique.modal.titre." + themeKey) || (t("boutique.modal.titre") + " " + themeKey);

  // Image principale dans /assets/modes/
  const webp = `assets/modes/${themeKey}.webp`;
  const png  = `assets/modes/${themeKey}.png`;
  $img.src = webp;
  $img.alt = themeKey;
  $img.onerror = () => { if ($img.src.endsWith('.webp')) $img.src = png; };

  // Actions dynamiques
  renderModalActions(themeKey);

  $backdrop.style.display = 'flex';
  $backdrop.setAttribute('aria-hidden', 'false');

  // i18n sur éléments injectés
  if (window.applyI18n && window.I18N_MAP) window.applyI18n(window.I18N_MAP);
}
function closeThemeModal() {
  $backdrop.style.display = 'none';
  $backdrop.setAttribute('aria-hidden', 'true');
}
async function renderModalActions(themeKey) {
  $actions.innerHTML = '';
  const unlocked = await userData.getUnlockedThemes?.() || [];
  const isUnlocked = unlocked.includes(themeKey);

  if (isUnlocked) {
    const badge = document.createElement('div');
    badge.className = 'badge';
    badge.setAttribute('data-i18n', 'boutique.modal.possede');
    badge.textContent = t('boutique.modal.possede');
    $actions.appendChild(badge);
  } else {
    const buy = document.createElement('button');
    buy.className = 'btn btn-primary';
    buy.setAttribute('data-i18n', 'boutique.modal.acheter');
    buy.textContent = (t('boutique.modal.acheter') || 'Acheter') + ` (${THEME_PRICE} VCoins)`;
    buy.onclick = async () => {
      const coins = await userData.getVCoins();
      if (coins < THEME_PRICE) {
        alert(t("boutique.alert.pasassez"));
        return;
      }
      await userData.addVCoins(-THEME_PRICE);
      await unlockThemeCloud(themeKey);
      await renderThemes(); // refresh listes/solde
      renderModalActions(themeKey); // convertir le bouton en “Possédé”
      if (window.applyI18n && window.I18N_MAP) window.applyI18n(window.I18N_MAP);
    };
    $actions.appendChild(buy);
  }

  const closeBtn = document.createElement('button');
  closeBtn.className = 'btn btn-ghost';
  closeBtn.setAttribute('data-i18n', 'boutique.modal.fermer');
  closeBtn.textContent = t('boutique.modal.fermer') || 'Fermer';
  closeBtn.onclick = closeThemeModal;
  $actions.appendChild(closeBtn);
}

/** INIT */
function ready(fn) {
  if (window.i18nReady && typeof window.i18nReady.then === "function") {
    window.i18nReady.then(fn);
  } else {
    setTimeout(fn, 0);
  }
}
ready(async () => {
  await renderThemes();
  setupPubCartouches();
  setupBoutiqueAchats();

  // i18n global après génération dynamique
  if (window.applyI18n && window.I18N_MAP) window.applyI18n(window.I18N_MAP);
  if (window.i18nGet) document.title = window.i18nGet("boutique.titre") || "Boutique";
});
</script>
</body>
</html>
