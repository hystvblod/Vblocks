<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title data-i18n="duel.title">V-Blocks - Duel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <script>
    // Thème identique au "classic"
    let currentTheme = localStorage.getItem('themeVBlocks') || 'neon';
    document.documentElement.setAttribute('data-theme', currentTheme);
    window.addEventListener('DOMContentLoaded', () => {
      document.body.setAttribute('data-theme', currentTheme);
      if(window.i18n && window.i18n["duel.title"]) document.title = window.i18n["duel.title"];
    });
  </script>
  <link rel="stylesheet" href="themes/themes.css" id="theme-style" />
  <style>
    /* === mêmes bases que classic === */
    html, body {
      margin: 0; padding: 0;
      width: 100vw; height: 100dvh;
      box-sizing: border-box;
      font-family: 'Quicksand', Arial, sans-serif;
      background: var(--body-bg, #111);
      color: var(--body-color, #ccc);
      overflow: hidden;
      height: 100%;
    }
    body {
      display: flex; flex-direction: column;
      min-height: 100dvh; height: 100dvh;
      width: 100vw;
      align-items: center; justify-content: flex-start;
    }
    .main-content {
      display: flex;
      flex-direction: column;
      width: 100vw;
      max-width: 430px;
      height: 100dvh;
      min-height: 100dvh;
      box-sizing: border-box;
      align-items: center;
      justify-content: flex-start;
      margin: 0 auto;
    }

    /* === TOP BAR (comme classic) === */
    .top-bar {
      width: 100%;
      max-width: 430px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      padding: 10px 10px 0 10px;
      position: relative;
      z-index: 10;
      background: transparent;
    }
    .top-bar-row {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      gap: 8px;
    }
    .btn-back {
      background: none;
      border: none;
      display: flex; align-items: center; justify-content: center;
      border-radius: 50%; padding: 4px;
      cursor: pointer;
      width: 42px; height: 42px;
      transition: background 0.15s;
    }
    .btn-back img { width: 28px; height: 28px; filter: drop-shadow(0 1px 2px #0005);}
    .main-title {
      flex: 1;
      font-size: 1.25em; font-weight: 900;
      color: var(--title-color, #39ff14);
      letter-spacing: 2px; line-height: 1.1;
      text-align: center;
      white-space: pre-line;
      word-break: break-word;
      user-select: none;
    }
    .profile-row {
      display: flex;
      flex-direction: row;
      gap: 8px;
    }
    .btn-icon img { width: 27px; height: 27px; }

    /* === Wallet identique === */
    .wallet-block {
      width: 100%;
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;
      gap: 18px;
      margin: 0 0 7px 0;
      min-height: 38px;
    }
    .vcoins, .jetons {
      display: flex;
      align-items: center;
      font-weight: 700;
      justify-content: center;
    }
    .vcoins { font-size: 1.19em; color: #ffd800; }
    .jetons { font-size: 1.07em; color: #ffd800; }
    .vcoin-icon, .jeton-icon {
      width: 27px; height: 27px;
      vertical-align: middle;
      margin-right: 6px;
    }

    @media (max-width:480px) {
      .main-content { max-width: 100vw; }
      .top-bar { padding: 4px 3px 0 3px; max-width: 99vw; }
      .main-title { font-size: .99em; }
      .btn-back { width: 32px; height: 32px; }
      .btn-back img, .btn-icon img { width: 20px; height: 20px; }
      .wallet-block { gap: 8px; margin-bottom: 4px; }
      .vcoin-icon, .jeton-icon { width: 16px; height: 16px; margin-right: 3px; }
      .vcoins { font-size: .97em; }
      .jetons { font-size: .88em; }
    }

    /* === Panneaux HOLD/NEXT + pause identiques === */
    .top-canvas-row {
      width: 100%; max-width: 410px;
      display: flex; justify-content: space-between; align-items: flex-end;
      margin-bottom: 2px;
      margin-top: -30px;
      flex-shrink: 0;
    }
    .side-canvas-block { display: flex; flex-direction: column; align-items: center; gap: 2px; }
    .side-canvas-block label {
      font-size: 1em; font-weight: 700; margin-bottom: 2px; color: var(--panel-text, #39ff14);
      text-align: center;
    }
    #holdCanvas, #nextCanvas {
      background: var(--canvas-panel-bg, #161649);
      border: 2px dashed var(--canvas-panel-border, #00fff7);
      border-radius: 0.4em; box-shadow: 0 2px 7px #39ff1411;
      display: block; margin: 0 auto;
    }

    /* === Zone de jeu identique === */
    .game-flex-wrap {
      width: 100%; flex: 1 1 0; min-height: 0; min-width: 0;
      display: flex; justify-content: center; align-items: center;
      margin-bottom: 4px;
    }
    #gameCanvas {
      width: 100%; max-width: 330px; aspect-ratio: 10/20;
      height: auto; max-height: 100%;
      background: var(--canvas-bg, #180654);
      border-radius: 0.4em; box-shadow: 0 6px 32px #39ff1411;
      display: block; margin: 0 auto;
      touch-action: none;
    }

    /* === Scores identiques === */
    .score-row {
      margin-top: 8px; font-size: 1.08em; font-weight: 700;
      display: flex; flex-wrap: wrap; justify-content: center; gap: 1em 2em;
      color: var(--score-color, #39ff14);
      width: 97vw; max-width: 430px; letter-spacing: 0.6px; flex-shrink: 0;
    }
    .score-group { display: flex; align-items: center; gap: 0.5em; }
    .score-label { min-width: 50px; text-align: right; color: var(--score-color, #39ff14);}
    .score-value { min-width: 30px; text-align: left; color: var(--score-color, #39ff14); font-weight: 700;}
    .highscore-global { font-size: 1.12em; font-weight: bold; color: #ffd800; margin-left: 1.1em;}
    .highscore-value { color: var(--highscore-color, #ffd800); font-weight: 700; }

    /* === Boutons identiques === */
    #controls { display: flex; justify-content: center; gap: 1.1em; margin-top: 11px; flex-shrink: 0; }
    #controls button {
      background: var(--btn-bg, #161649);
      color: var(--btn-color, #39ff14);
      font-weight: 700; border: none; border-radius: 1.1em;
      padding: 0.68em 1.4em; font-size: 1.03em;
      cursor: pointer; box-shadow: 0 1.5px 7px #00fff738;
    }
    #controls button:active {
      background: var(--btn-hover-bg, #181885);
      color: var(--btn-hover-color, #fff);
    }

    /* === Popup Duel (inchangé visuel) === */
    #duelPopup {
      position: fixed; left: 0; top: 0; width: 100vw; height: 100vh; z-index: 1000;
      background: rgba(12,16,44,0.85); display: flex; align-items: center; justify-content: center;
    }
    #duelPopup > div {
      background: #23294a; border-radius: 1em; box-shadow: 0 0 18px #00fff74c;
      padding: 32px 18px 24px; min-width: 270px; max-width: 96vw;
      color: #fff; text-align: center;
    }
    .duel-btn {
      margin: 8px 4px 0 4px; font-size: 1.12em; font-weight: bold;
      border-radius: 0.7em; border: none; padding: 0.52em 1.6em;
      background: #161649; color: #39ff14; cursor: pointer;
    }
    .duel-btn:hover { background: #181885; }
    .duel-link {
      font-size: 1.01em; background: #151537; border-radius: 0.5em;
      padding: 0.4em 1em; color: #ffd800; margin-bottom: 10px; user-select: all;
    }
    .duel-code { font-size: 1.5em; letter-spacing: 2px; margin: 8px 0 6px 0; color: #ffd800; font-family: monospace; }
  </style>
</head>
<body>
  <!-- fond optionnel comme classic -->
  <canvas id="starfield" style="position:fixed; top:0; left:0; width:100vw; height:100vh; z-index:-1; display:none;"></canvas>

  <div class="main-content">
    <!-- === BARRE TOP EXACTEMENT COMME CLASSIC === -->
    <div class="top-bar">
      <div class="top-bar-row">
        <a href="index.html" class="btn-back" title="Retour">
          <img src="assets/icons/arrow_back.svg" alt="Retour" />
        </a>
        <span class="main-title" data-i18n="duel.main_title">DUEL</span>
        <div class="profile-row">
          <a href="profil.html" class="btn-icon" title="Profil">
            <img src="assets/icons/user.svg" alt="Profil" />
          </a>
          <a href="parametres.html" class="btn-icon" title="Paramètres">
            <img src="assets/icons/settings.svg" alt="Paramètres" />
          </a>
        </div>
      </div>
      <div class="wallet-block">
        <span class="vcoins">
          <img src="assets/images/vcoin.webp" alt="VCoins" class="vcoin-icon">
          <span id="vcoin-amount">0</span>
        </span>
        <span class="jetons">
          <img src="assets/images/jeton.webp" alt="Jetons" class="jeton-icon" data-i18n="jetons.alt">
          <span id="jeton-amount">0</span>
        </span>
      </div>
    </div>

    <!-- === POPUP DUEL === -->
    <div id="duelPopup"></div>

    <!-- === Panneaux HOLD / PAUSE / NEXT (comme classic) === -->
    <div class="top-canvas-row">
      <div class="side-canvas-block">
        <label data-i18n="game.hold">Réserve</label>
        <canvas id="holdCanvas" width="48" height="48"></canvas>
      </div>
      <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; min-width:54px;">
        <button id="pause-btn" style="background:none;border:none;cursor:pointer;padding:2px;border-radius:99px;">
          <img src="assets/icons/pause.svg" alt="Pause" style="width:36px;height:36px;display:block;">
        </button>
      </div>
      <div class="side-canvas-block">
        <label data-i18n="game.next">Suivante</label>
        <canvas id="nextCanvas" width="48" height="48"></canvas>
      </div>
    </div>

    <!-- === CANVAS PRINCIPAL (mêmes styles) === -->
    <div class="game-flex-wrap">
      <canvas id="gameCanvas"></canvas>
    </div>

    <!-- === SCORE (mêmes classes/typos) === -->
    <div class="score-row" id="score-row">
      <div class="score-group">
        <span class="score-label" data-i18n="duel.score">Score</span>
        <span class="score-value" id="score">0</span>
      </div>
      <div class="score-group">
        <span class="highscore-global" data-i18n="game.record">Record&nbsp;:</span>
        <span class="highscore-value" id="highscore-global">0</span>
      </div>
    </div>

    <!-- === CONTROLES identiques === -->
    <div id="controls">
      <button id="music-btn" data-i18n="game.music">Musique</button>
      <button onclick="location.reload()" data-i18n="game.replay">Rejouer</button>
    </div>
  </div>

  <audio id="music" src="assets/sounds/chill.mp3" loop></audio>

  <!-- ==== SCRIPTS ==== -->
  <script src="js/vendor/supabase-2.42.5.min.js"></script>
  <script src="js/i18n.js"></script>
  <script src="js/pub.js"></script>
  <script src="js/userData.js"></script>
  <script src="js/game_duel.js"></script>

  <script>
    // Bouton musique (même logique)
    const music = document.getElementById("music");
    document.getElementById("music-btn").onclick = function() {
      if (music.paused) {
        music.play();
        this.textContent = (window.i18n && window.i18n["game.music"]) ? window.i18n["game.music"] : "Musique";
      } else {
        music.pause();
        this.textContent = (window.i18n && window.i18n["game.mute"]) ? window.i18n["game.mute"] : "Muet";
      }
    };

    // Affichages comme classic
    async function updateVCoinsDisplay() {
      let vcoins = 0;
      try { if(window.userData?.getVCoins) vcoins = await userData.getVCoins(); } catch(e) { vcoins = 0; }
      document.getElementById("vcoin-amount").textContent = vcoins ?? 0;
    }
    async function updateJetonsDisplay() {
      let jetons = 0;
      try { if(window.userData?.getJetons) jetons = await userData.getJetons(); } catch(e) { jetons = 0; }
      document.getElementById("jeton-amount").textContent = jetons ?? 0;
    }
    async function updateHighScoreDisplay() {
      if (window.userData?.getHighScore) {
        const score = await userData.getHighScore();
        document.getElementById("highscore-global").textContent = score ?? 0;
      }
    }
    function updateScore(val) { document.getElementById("score").textContent = val; }

    document.addEventListener("DOMContentLoaded", () => {
      updateVCoinsDisplay();
      updateJetonsDisplay();
      updateHighScoreDisplay();
    });
    window.updateHighScoreDisplay = updateHighScoreDisplay;
    window.updateVCoinsDisplay = updateVCoinsDisplay;
    window.updateJetonsDisplay = updateJetonsDisplay;
    window.updateScore = updateScore;

    /* === POPUPS DUEL === */
    function i18nT(key) {
      if (window.I18N_MAP && window.I18N_MAP[key]) return window.I18N_MAP[key];
      return key;
    }

    function showDuelPopup(state, data = {}) {
      const popup = document.getElementById('duelPopup');
      popup.style.display = 'flex';
      popup.style.background = "rgba(0,0,0,0.85)";
      let html = '';

      if (state === 'choice') {
        html = `
          <div>
            <h2 data-i18n="duel.popup.choice.title">${i18nT("duel.popup.choice.title")}</h2>
            <button class="duel-btn" id="btnNewDuel" data-i18n="duel.popup.choice.new"></button>
            <br>
            <button class="duel-btn" id="btnJoinDuel" data-i18n="duel.popup.choice.join"></button>
            <br><br>
            <button style="padding:0.4em 1em;font-size:0.9em;border-radius:0.5em;border:none;background:#444;color:#fff;cursor:pointer;"
                onclick="window.location.href='index.html'">
              ${i18nT("button.back")}
            </button>
          </div>`;
      }
      if (state === 'wait') {
        html = `<div>
          <h2 data-i18n="duel.popup.wait.title">${i18nT("duel.popup.wait.title")}</h2>
          <div data-i18n="duel.popup.wait.code">${i18nT("duel.popup.wait.code")}</div>
          <div class="duel-code">${data.code}</div>
          <div class="duel-link">
            <input style="width:99%;font-size:1em;" value="${location.origin}${location.pathname}?duel=${data.code}&player=2" readonly onclick="this.select()">
          </div>
          <div style="margin-top:1em;" data-i18n="duel.popup.wait.text">${i18nT("duel.popup.wait.text")}</div>
        </div>`;
      }
      if (state === 'confirm') {
        html = `<div>
          <h2 data-i18n="duel.popup.confirm.title">${i18nT("duel.popup.confirm.title")}</h2>
          <div data-i18n="duel.popup.confirm.text">${i18nT("duel.popup.confirm.text")}</div>
          <button class="duel-btn" id="btnAcceptDuel" data-i18n="duel.popup.confirm.accept"></button>
          <button class="duel-btn" id="btnRefuseDuel" data-i18n="duel.popup.confirm.refuse"></button>
        </div>`;
      }
      if (state === 'countdown') {
        html = `<div>
          <h2 data-i18n="duel.popup.countdown.title">${i18nT("duel.popup.countdown.title")}</h2>
          <div id="countdown" style="font-size:2.5em">3</div>
        </div>`;
      }
      if (state === 'join') {
        html = `<div>
          <h2 data-i18n="duel.popup.join.title">${i18nT("duel.popup.join.title")}</h2>
          <input id="inputCode" maxlength="8" style="font-size:1.2em;letter-spacing:2px;text-align:center">
          <button class="duel-btn" id="btnJoinOk" data-i18n="duel.popup.join.ok"></button>
          <button class="duel-btn" id="btnJoinCancel" data-i18n="duel.popup.join.cancel"></button>
        </div>`;
      }

      popup.innerHTML = html;
      if (window.i18nTranslateAll) window.i18nTranslateAll();

      if (state === 'choice') {
        document.getElementById('btnNewDuel').onclick = createNewDuel;
        document.getElementById('btnJoinDuel').onclick = () => showDuelPopup('join');
      }
      if (state === 'join') {
        const input = document.getElementById('inputCode');
        if (input && window.i18n) input.placeholder = window.i18n["duel.popup.join.placeholder"] || "Code duel...";
        document.getElementById('btnJoinOk').onclick = function() {
          let code = input.value.trim().toUpperCase();
          if (!code) return;
          window.location.href = `${location.pathname}?duel=${code}&player=2`;
        };
        document.getElementById('btnJoinCancel').onclick = function() { location.reload(); };
      }
      if (state === 'confirm') {
        document.getElementById('btnAcceptDuel').onclick = onAcceptDuel;
        document.getElementById('btnRefuseDuel').onclick = () => window.location = "index.html";
      }
    }

    /* === Flow DUEL (identique logique, patch UID + update contrôlé) === */
    let duelId = null, duelCode = null, playerNum = 1;

    async function startDuelFlow() {
      const urlParams = new URLSearchParams(window.location.search);
      duelCode = urlParams.get('duel');
      playerNum = parseInt(urlParams.get('player')) || 1;

      if (!duelCode) { showDuelPopup('choice'); return; }

      const { data, error } = await window.sb.from('duels').select('*').eq('code', duelCode).single();
      if (error || !data) { showDuelPopup('choice'); alert("Ce duel n'existe pas ou a expiré."); return; }
      duelId = data.id;

      if (playerNum === 1) {
        showDuelPopup('wait', { code: duelCode });
      } else if (playerNum === 2) {
        const uid = (window.getUserId ? await window.getUserId() : null);
        if (!uid) { alert("Impossible de rejoindre (UID null). Active l’auth anonyme et recharge."); return; }
        if (data.player2 && data.player2 !== uid) { alert("Cette room est déjà pleine."); return; }

        const { data: after, error: updErr } = await window.sb
          .from('duels')
          .update({ player2: uid, status: "pending" })
          .eq('id', duelId)
          .select('id, player1, player2, status')
          .single();

        if (updErr) { console.error('[DUEL] update player2 failed:', updErr); alert("Échec pour rejoindre le duel (UPDATE)."); return; }
        if (!after?.player2) { console.warn('[DUEL] UPDATE ok mais player2 vide:', after); alert("player2 est resté vide (UID manquant)."); return; }

        showDuelPopup('confirm');
      }
      pollDuelStatus();
    }

    async function createNewDuel() {
      const uid = (window.getUserId ? await window.getUserId() : null);
      if (!uid) { alert("Auth introuvable (UID null)."); return; }

      duelCode = genDuelCode();
      let { data, error } = await window.sb.from('duels').insert([{
        code: duelCode, player1: uid, status: "waiting"
      }]).select().single();

      duelId = data?.id;
      if (error || !duelId) { console.log("[DUEL] ERREUR création:", error, data); alert("Erreur lors de la création du duel."); showDuelPopup('choice'); return; }
      showDuelPopup('wait', { code: duelCode });
      pollDuelStatus();
    }

    async function onAcceptDuel() {
      const { error: e1 } = await window.sb.from('duels').update({ status: 'ready' }).eq('id', duelId);
      if (e1) { console.error(e1); alert('MAJ status failed'); return; }

      const { data, error: e2 } = await window.sb.from('duels').select('*').eq('id', duelId).single();
      if (e2) { console.error(e2); alert('Lecture duel failed'); return; }

      if (data && !data.pieces_seq) {
        const seq = Array.from({ length: 1000 }, () => Math.floor(Math.random() * 7)).join(',');
        const { error: e3 } = await window.sb.from('duels')
          .update({ pieces_seq: seq, status: "started" })
          .eq('id', duelId);
        if (e3) { console.error(e3); alert('MAJ seq failed'); return; }
      } else {
        const { error: e4 } = await window.sb.from('duels')
          .update({ status: "started" })
          .eq('id', duelId);
        if (e4) { console.error(e4); alert('Start failed'); return; }
      }
      showDuelPopup('countdown');
      startCountdown();
    }

    async function pollDuelStatus() {
      let tries = 0;
      while (tries++ < 80) {
        const { data, error } = await window.sb.from('duels').select('*').eq('code', duelCode).single();
        if (error) { await new Promise(r => setTimeout(r, 1000)); continue; }
        if (!data) break;

        if (data.status === "waiting") showDuelPopup('wait', { code: duelCode });
        if (playerNum === 2 && data.status === "pending") showDuelPopup('confirm');

        if ((playerNum === 1 || playerNum === 2) && data.status === "started" && data.pieces_seq) {
          showDuelPopup('countdown');
          startCountdown();
          break;
        }
        await new Promise(r => setTimeout(r, 1000));
      }
    }

    function startCountdown() {
      let n = 3;
      const ctd = setInterval(() => {
        const el = document.getElementById('countdown');
        if (el) el.textContent = n;
        n--;
        if (n < 0) {
          clearInterval(ctd);
          document.getElementById('duelPopup').style.display = 'none';
          if (typeof VBlocksGame !== "undefined" && VBlocksGame.initGame)
            VBlocksGame.initGame({ mode: 'duel', duelId: duelId, duelPlayerNum: playerNum });
        }
      }, 1000);
    }

    // Utils
    function genDuelCode(len = 6) {
      const chars = "ABCDEFGHJKMNPQRSTUVWXYZ23456789";
      let code = '';
      for (let i = 0; i < len; i++) code += chars.charAt(Math.floor(Math.random() * chars.length));
      return code;
    }

    // Lancement: même séquence que classic + auth avant flow
    window.addEventListener("DOMContentLoaded", async () => {
      try {
        if (window.i18nReady) { try { await window.i18nReady; } catch(e){} }
        if (window.bootstrapAuthAndProfile) { await window.bootstrapAuthAndProfile(); }
        await startDuelFlow();
      } catch (e) {
        console.error('[DUEL] init failed', e);
        alert("Init duel impossible (auth).");
      }
    });

    // Thème live (comme classic)
    window.addEventListener("storage", (e) => {
      if (e.key === "themeVBlocks") {
        currentTheme = localStorage.getItem('themeVBlocks') || "neon";
        document.documentElement.setAttribute('data-theme', currentTheme);
        document.body.setAttribute('data-theme', currentTheme);
        const style = document.getElementById('theme-style');
        if(style) style.href = `themes/themes.css`;
        location.reload();
      }
    });
  </script>
</body>
</html>
