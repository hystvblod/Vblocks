<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title data-i18n="game.title">V-Blocks - Classique</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <script>
    let currentTheme = localStorage.getItem('themeVBlocks') || 'neon';
    document.documentElement.setAttribute('data-theme', currentTheme);
    window.addEventListener('DOMContentLoaded', () => {
      document.body.setAttribute('data-theme', currentTheme);
      if(window.i18n && window.i18n["game.title"]) document.title = window.i18n["game.title"];
      // Pour main-title aussi :
      let mt = document.querySelector('.main-title');
      if (mt && window.i18n && window.i18n["game.main_title"]) mt.innerHTML = window.i18n["game.main_title"];
    });
  </script>
  <link rel="stylesheet" href="themes/themes.css" id="theme-style" />
  <style>
    html, body {
      margin: 0; padding: 0;
      width: 100vw; height: 100dvh;
      box-sizing: border-box;
      font-family: 'Quicksand', Arial, sans-serif;
      background: var(--body-bg, #111);
      color: var(--body-color, #ccc);
      overflow: hidden;
      height: 100%;
    }
    body {
      display: flex; flex-direction: column;
      min-height: 100dvh; height: 100dvh;
      width: 100vw;
      align-items: center; justify-content: flex-start;
    }
    .main-content {
      display: flex;
      flex-direction: column;
      width: 100vw;
      max-width: 430px;
      height: 100dvh;
      min-height: 100dvh;
      box-sizing: border-box;
      align-items: center;
      justify-content: flex-start;
      margin: 0 auto;
    }
    .top-bar {
      width: 100%;
      max-width: 430px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      padding: 10px 10px 0 10px;
      position: relative;
      z-index: 10;
      background: transparent;
    }
    .top-bar-row {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      gap: 8px;
    }
    .btn-back {
      background: none;
      border: none;
      display: flex; align-items: center; justify-content: center;
      border-radius: 50%; padding: 4px;
      cursor: pointer;
      width: 42px; height: 42px;
      transition: background 0.15s;
    }
    .btn-back img { width: 28px; height: 28px; filter: drop-shadow(0 1px 2px #0005); }
    .main-title {
      flex: 1;
      font-size: 1.25em; font-weight: 900;
      color: var(--title-color, #39ff14);
      letter-spacing: 2px; line-height: 1.1;
      text-align: center;
      white-space: pre-line;
      word-break: break-word;
      user-select: none;
    }
    .profile-row {
      display: flex;
      flex-direction: row;
      gap: 8px;
    }
    .btn-icon img { width: 27px; height: 27px; }

    .wallet-block {
      width: 100%;
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;
      gap: 18px;
      margin: 0 0 7px 0;
      min-height: 38px;
    }
    .vcoins, .jetons {
      display: flex;
      align-items: center;
      font-weight: 700;
      justify-content: center;
    }
    .vcoins { font-size: 1.19em; color: #ffd800; }
    .jetons { font-size: 1.07em; color: #ffd800; }
    .vcoin-icon, .jeton-icon {
      width: 27px; height: 27px;
      vertical-align: middle;
      margin-right: 6px;
    }

    /* ✅ nouvelle ligne centrée entre wallet et bouton Pause */
    .score-to-beat-row {
      width: 100%;
      display: flex;
      justify-content: center;
      margin: 4px 0 6px; /* pile entre le solde et le bouton pause */
    }

    @media (max-width:480px) {
      .main-content { max-width: 100vw; }
      .top-bar { padding: 4px 3px 0 3px; max-width: 99vw; }
      .main-title { font-size: .99em; }
      .btn-back { width: 32px; height: 32px; }
      .btn-back img, .btn-icon img { width: 20px; height: 20px; }
      .wallet-block { gap: 8px; margin-bottom: 4px; }
      .vcoin-icon, .jeton-icon { width: 16px; height: 16px; margin-right: 3px; }
      .vcoins { font-size: .97em; }
      .jetons { font-size: .88em; }
      .score-to-beat-row { margin: 2px 0 4px; }
    }

    .top-canvas-row {
      width: 100%; max-width: 410px;
      display: flex; justify-content: space-between; align-items: flex-end;
      margin-bottom: 2px;
      margin-top: -30px;
      flex-shrink: 0;
    }
    .side-canvas-block {
      display: flex; flex-direction: column; align-items: center; gap: 2px;
    }
    .side-canvas-block label {
      font-size: 1em; font-weight: 700; margin-bottom: 2px; color: var(--panel-text, #39ff14);
      text-align: center;
    }
    #holdCanvas, #nextCanvas {
      background: var(--canvas-panel-bg, #161649);
      border: 2px dashed var(--canvas-panel-border, #00fff7);
      border-radius: 0.4em; box-shadow: 0 2px 7px #39ff1411;
      display: block; margin: 0 auto;
    }
    .game-flex-wrap {
      width: 100%; flex: 1 1 0; min-height: 0; min-width: 0;
      display: flex; justify-content: center; align-items: center;
      margin-bottom: 4px;
    }
    #gameCanvas {
      width: 100%; max-width: 330px; aspect-ratio: 10/20;
      height: auto; max-height: 100%;
      background: var(--canvas-bg, #180654);
      border-radius: 0.4em; box-shadow: 0 6px 32px #39ff1411;
      display: block; margin: 0 auto;
      touch-action: none;
    }
    .score-row {
      margin-top: 8px; font-size: 1.08em; font-weight: 700;
      display: flex; flex-wrap: wrap; justify-content: center; gap: 1em 2em;
      color: var(--score-color, #39ff14);
      width: 97vw; max-width: 430px; letter-spacing: 0.6px; flex-shrink: 0;
    }
    .score-group { display: flex; align-items: center; gap: 0.5em; }
    .score-label { min-width: 50px; text-align: right; color: var(--score-color, #39ff14); }
    .score-value { min-width: 30px; text-align: left; color: var(--score-color, #39ff14); font-weight: 700; }
    .highscore-global { font-size: 1.12em; font-weight: bold; color: #ffd800; margin-left: 1.1em; }
    .highscore-value { color: var(--highscore-color, #ffd800); font-weight: 700; }
    #controls {
      display: flex; justify-content: center; gap: 1.1em; margin-top: 11px; flex-shrink: 0;
    }
    #controls button {
      background: var(--btn-bg, #161649);
      color: var(--btn-color, #39ff14);
      font-weight: 700; border: none; border-radius: 1.1em;
      padding: 0.68em 1.4em; font-size: 1.03em;
      cursor: pointer; box-shadow: 0 1.5px 7px #00fff738;
    }
    #controls button:active {
      background: var(--btn-hover-bg, #181885);
      color: var(--btn-hover-color, #fff);
    }

    /* === Score à battre (pills) === */
    .score-to-beat {
      font-size: 1.1em;
      font-weight: 900;
      color: #ffeb3b;
      letter-spacing: .5px;
      text-shadow: 0 2px 6px rgba(0,0,0,.35);
      padding: .45em .9em;
      border-radius: 1.1em;
      background: rgba(255,255,255,.06);
    }
  </style>
</head>
<body>
  <canvas id="starfield" style="position:fixed; top:0; left:0; width:100vw; height:100vh; z-index:-1; display:none;"></canvas>
  <div class="main-content">
    <!-- BARRE TOP -->
    <div class="top-bar">
      <div class="top-bar-row">
        <a href="index.html" class="btn-back" title="Retour">
          <img src="assets/icons/arrow_back.svg" alt="Retour" />
        </a>
        <span class="main-title" data-i18n="game.main_title">V-Blocks- Classique</span>
        <div class="profile-row">
          <a href="profil.html" class="btn-icon" title="Profil">
            <img src="assets/icons/user.svg" alt="Profil" />
          </a>
          <a href="parametres.html" class="btn-icon" title="Paramètres">
            <img src="assets/icons/settings.svg" alt="Paramètres" />
          </a>
        </div>
      </div>
      <div class="wallet-block">
        <span class="vcoins">
          <img src="assets/images/vcoin.webp" alt="VCoins" class="vcoin-icon">
          <span id="vcoin-amount">0</span>
        </span>
        <span class="jetons">
          <img src="assets/images/jeton.webp" alt="Jetons" class="jeton-icon" data-i18n="jetons.alt">
          <span id="jeton-amount">0</span>
        </span>
      </div>

      <!-- ✅ NOUVELLE LIGNE : Score à battre (entre solde et bouton Pause) -->
      <div class="score-to-beat-row">
        <div class="score-to-beat">
          <span class="score-to-beat-label" data-i18n="game.score_to_beat">Score à battre</span>&nbsp;:
          <span id="score-to-beat-value-top">--</span>
        </div>
      </div>
    </div>

    <!-- PIECES -->
    <div class="top-canvas-row">
      <div class="side-canvas-block">
        <label data-i18n="game.hold">Réserve</label>
        <canvas id="holdCanvas" width="48" height="48"></canvas>
      </div>
      <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; min-width:54px;">
        <!-- (ancien chip top conservé, id changé pour éviter doublons) -->
        <div class="score-to-beat" style="margin-bottom:6px; display:none;">
          <span class="score-to-beat-label" data-i18n="game.score_to_beat">Score à battre</span>&nbsp;:
          <span id="score-to-beat-value-legacy">--</span>
        </div>
        <button id="pause-btn"  style="background:none;border:none;cursor:pointer;padding:2px;border-radius:99px;" >
          <img src="assets/icons/pause.svg" alt="Pause" style="width:36px;height:36px;display:block;">
        </button>
      </div>
      <div class="side-canvas-block">
        <label data-i18n="game.next">Suivante</label>
        <canvas id="nextCanvas" width="48" height="48"></canvas>
      </div>
    </div>
    <!-- CANVAS PRINCIPAL -->
    <div class="game-flex-wrap">
      <canvas id="gameCanvas"></canvas>
    </div>
    <!-- SCORE -->
    <div class="score-row" id="score-row">
      <div class="score-group">
        <span class="score-label" data-i18n="game.score">Score</span>
        <span class="score-value" id="score">0</span>
      </div>
      <div class="score-group">
        <span class="highscore-global" data-i18n="game.record">Record&nbsp;:</span>
        <span class="highscore-value" id="highscore-global">0</span>
      </div>
    </div>
    <div id="controls">
      <button id="music-btn" data-i18n="game.music">Musique</button>
      <!-- ✨ Remplacement du bouton Rejouer par "Score à battre" -->
      <div id="score-to-beat" class="score-to-beat">
        <span class="score-to-beat-label" data-i18n="game.score_to_beat">Score à battre</span>&nbsp;:
        <span id="score-to-beat-value">--</span>
      </div>
    </div>
  </div>

  <audio id="music" src="assets/sounds/chill.mp3" loop></audio>

  <!-- ==== SCRIPTS ==== -->
  <script>
    // Musique bouton
    const music = document.getElementById("music");
    document.getElementById("music-btn").onclick = function() {
      if (music.paused) {
        music.play();
        this.textContent = (window.i18n && window.i18n["game.music"]) ? window.i18n["game.music"] : "Musique";
      } else {
        music.pause();
        this.textContent = (window.i18n && window.i18n["game.mute"]) ? window.i18n["game.mute"] : "Muet";
      }
    };

    // Affichage VCoins/Jetons depuis Supabase (via userData.js)
    async function updateVCoinsDisplay() {
      let vcoins = 0;
      try {
        if(window.userData && userData.getVCoins) {
          vcoins = await userData.getVCoins();
        }
      } catch(e) { vcoins = 0; }
      document.getElementById("vcoin-amount").textContent = vcoins ?? 0;
    }
    async function updateJetonsDisplay() {
      let jetons = 0;
      try {
        if(window.userData && userData.getJetons) {
          jetons = await userData.getJetons();
        }
      } catch(e) { jetons = 0; }
      document.getElementById("jeton-amount").textContent = jetons ?? 0;
    }

    // Record cloud (table concours) — délègue à concours.js
    async function updateHighScoreDisplay() {
      if (typeof window.updateHighscoreDisplay === 'function') {
        await window.updateHighscoreDisplay();
      } else {
        document.getElementById("highscore-global").textContent = '0';
      }
    }

    // Score à battre (max global concours) — met à jour BAS + HAUT
    async function updateScoreToBeatUI() {
      const bottomEl = document.getElementById('score-to-beat-value');
      const topEl    = document.getElementById('score-to-beat-value-top');
      const legacyEl = document.getElementById('score-to-beat-value-legacy');

      // Si concours.js fournit sa fonction, on l'appelle (évite récursion)
      if (typeof window.updateScoreToBeatUI === 'function' && window.updateScoreToBeatUI !== updateScoreToBeatUI) {
        await window.updateScoreToBeatUI();
        // copie bas -> haut
        if (bottomEl && topEl)   topEl.textContent   = bottomEl.textContent;
        if (bottomEl && legacyEl) legacyEl.textContent = bottomEl.textContent;
        return;
      }

      // Fallback
      const v = '--';
      if (bottomEl) bottomEl.textContent = v;
      if (topEl)    topEl.textContent    = v;
      if (legacyEl) legacyEl.textContent = v;
    }

    // Score en live (partie locale)
    function updateScore(val) {
      document.getElementById("score").textContent = val;
    }

    document.addEventListener("DOMContentLoaded", () => {
      updateVCoinsDisplay();
      updateJetonsDisplay();
      updateHighScoreDisplay();
      updateScoreToBeatUI();
    });

    // Expose pour mises à jour live
    window.updateHighScoreDisplay = updateHighScoreDisplay;
    window.updateScoreToBeatUI   = updateScoreToBeatUI;
    window.updateVCoinsDisplay   = updateVCoinsDisplay;
    window.updateJetonsDisplay   = updateJetonsDisplay;
    window.updateScore           = updateScore;
  </script>

  <!-- SCRIPTS FONCTIONNELS -->
  <!-- Supabase client -->
  <script src="js/vendor/supabase-2.42.5.min.js"></script>
  <!-- App utils -->
  <script src="js/i18n.js"></script>
  <script src="js/userData.js"></script>
  <!-- Ads -->
  <script src="js/pub.js"></script>
  <!-- Jeu (gère les scores concours + "score à battre") -->
  <script src="js/concours.js"></script>

  <!-- Gestion du thème en synchro multi-onglet -->
  <script>
    window.addEventListener("storage", (e) => {
      if (e.key === "themeVBlocks") {
        currentTheme = localStorage.getItem('themeVBlocks') || "neon";
        document.documentElement.setAttribute('data-theme', currentTheme);
        document.body.setAttribute('data-theme', currentTheme);
        const style = document.getElementById('theme-style');
        if(style) style.href = `themes/themes.css`;
        location.reload();
      }
    });
  </script>

  <!-- Lancement du jeu (doit rester APRES chargement des scripts précédents) -->
  <script>
    if (window.VBlocksGame && typeof window.VBlocksGame.initGame === "function") {
      window.VBlocksGame.initGame({ mode: 'classic' });
    } else {
      console.error("VBlocksGame is not defined. Vérifie l'ordre de tes scripts !");
    }
  </script>
</body>
</html>
