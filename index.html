<!DOCTYPE html>
<head>
  <meta charset="UTF-8" />
  <title>VBlocks - Accueil</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Bootstrap thème : défaut = retro + anti-flash -->
  <script>
    (function () {
      try {
        var KEY = 'themeVBlocks';
        if (!localStorage.getItem(KEY)) {
          localStorage.setItem(KEY, 'retro');
        }
        var th = localStorage.getItem(KEY) || 'retro';
        document.documentElement.setAttribute('data-theme', th);
      } catch(e) {}
    })();
  </script>

  <!-- Styles -->
  <link rel="stylesheet" href="style/main.css" />
  <style>
    .menu-btn.green  { background: #72eb63 !important; color: #ffffff !important; box-shadow: 0 3px 15px #2fd7b144; }
    .menu-btn.orange { background: #f0d642  !important; color: #fff !important; box-shadow: 0 3px 15px #2fd7b144; }
    .prix-blanc { color: white; font-size: 0.9em; display: block; margin-top: 5px; }

    /* Aligne le ? à droite et réserve la place pour le texte */
    .menu-btn { position: relative; }
    .menu-btn .btn-label { display:block; text-align:center; width:100%; padding: 0.9em 3.2em; }
    .menu-btn .info-btn{
      position:absolute; right:12px; top:50%; transform:translateY(-50%);
      width:28px; height:28px; border-radius:50%;
      display:inline-flex; align-items:center; justify-content:center;
      background:rgba(255,255,255,.25); color:#fff; font-weight:900; line-height:1; user-select:none;
    }

    /* Bannière MAJ non bloquante */
    #update-banner {
      position: fixed; left: 16px; right: 16px; bottom: 16px;
      background: rgba(17,17,17,.95); color: #fff;
      border-radius: 14px; padding: 14px; z-index: 99998;
      box-shadow: 0 8px 30px rgba(0,0,0,.35); display: none;
    }
    #update-banner h4 { margin: 0 0 6px; font-size: 1rem; }
    #update-banner p  { margin: 0 0 10px; opacity: .9; font-size: .95rem; }
    #update-banner .actions { display:flex; gap:10px; justify-content:flex-end; }
    #btn-update-now {
      border:0; border-radius: 10px; padding: 8px 12px; font-weight:700; cursor:pointer;
      background:#4caf50; color:#fff;
    }
    #btn-update-later {
      border:0; border-radius: 10px; padding: 8px 12px; font-weight:700; cursor:pointer;
      background:#333; color:#fff;
    }

    /* Popup consent (au-dessus de tous les calques pour capter les clics) */
    #popup-consent,
    .popup-consent-bg {
      position: fixed;
      inset: 0;
      display: none;
      z-index: 100050;
    }
    .popup-consent-bg { background: rgba(0,0,0,.45); backdrop-filter: blur(2px); }
    .popup-consent-box {
      position: absolute; left: 50%; top: 50%; transform:translate(-50%, -50%);
      width: min(560px, 92vw); background: #121212; color: #fff; border-radius: 18px;
      box-shadow: 0 20px 50px rgba(0,0,0,.45); padding: 18px;
    }
    .popup-consent-box h2 { margin: 0 0 8px; font-size: 1.2rem; }
    .popup-consent-box .row { display:flex; align-items:center; gap:12px; margin: 10px 0; }
    .popup-consent-box .row label { flex:1; }
    .popup-consent-box .row input[type="checkbox"] { width: 18px; height: 18px; }
    .popup-consent-box .actions { display: flex; gap: 12px; justify-content: flex-end; margin-top: 12px; }
    .popup-consent-box button {
      border:0; border-radius: 12px; padding: 10px 14px; font-weight: 700; cursor: pointer;
      background: #2a2a2a; color: #fff;
    }
    .popup-consent-box button.primary { background: #4caf50; }

    /* Tooltip */
    .tooltip {
      position: absolute; z-index: 9999; background: #1d1d1d; color: #fff; padding: 10px 12px; border-radius: 12px; display:none;
      transform: translate(-50%, 6px); box-shadow: 0 10px 30px rgba(0,0,0,.35); max-width: min(320px, 90vw);
    }
    .tooltip.visible { display: block; }
    .tooltip:before {
      content: ""; position: absolute; top: -8px; left: 50%; transform: translateX(-50%);
      border-left: 8px solid transparent; border-right: 8px solid transparent; border-bottom: 8px solid #1d1d1d;
    }

    /* “trait bleu” pour solde + score à battre */
    .barre-info {
      width: 100%; height: 44px; background: linear-gradient(90deg, #0e3a5d, #0b64b4); color:#fff;
      display:flex; align-items:center; justify-content:space-between; border-radius: 12px; padding: 0 12px; margin: 12px 0 18px;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.06), 0 6px 18px rgba(11,100,180,.25);
    }
    .barre-info .gauche, .barre-info .droite { display:flex; align-items:center; gap:10px; }
    .barre-info .pill {
      background: rgba(255,255,255,.18); border-radius:100px; padding: 6px 10px; font-weight: 700;
    }

    .menu-grid { display:grid; grid-template-columns:1fr; gap:14px; margin-top: 6px; }
    @media (min-width:560px){ .menu-grid { grid-template-columns: repeat(2,1fr); } }

    .menu-btn {
      display:block; text-decoration:none; background:#1f1f1f; color:#fff; border-radius: 14px; padding: 0; overflow:hidden;
      box-shadow: 0 10px 25px rgba(0,0,0,.25), inset 0 0 0 1px rgba(255,255,255,.06);
    }
    .menu-btn .thumb { height: 110px; background:#101010; display:flex; align-items:center; justify-content:center; }
    .menu-btn .thumb img { width:auto; height:100%; object-fit:cover; }
    .menu-btn .btn-label strong { display:block; font-size:1.05rem; }
    .menu-btn small { opacity:.85; display:block; margin-top: 4px; }

    /* Top buttons */
    .top-buttons { position: fixed; top: 14px; right: 14px; z-index: 9999; display:flex; gap: 8px; }
    .btn-icon { background: rgba(0,0,0,.5); border-radius: 12px; padding: 8px; display:inline-flex; align-items:center; justify-content:center; }
    .btn-icon img { width: 24px; height: 24px; filter: invert(100%); }

    /* Info-bulle */
    .info-score { font-size:.95rem; opacity:.9; }
  </style>

  <!-- i18n + libs -->
  <script src="js/i18n.js"></script>
  <script src="js/vendor/supabase-2.42.5.min.js"></script>
  <script src="js/userData.js"></script>
  <script src="capacitor.js"></script>
  <!-- Cordova/Capacitor bridge -->
  <script src="cordova.js"></script>

  <!-- Achats / pubs (après bridge) -->
  <script src="js/achat.js"></script>
  <!-- Ensuite seulement les scripts qui peuvent dépendre de Cordova -->
  <script src="js/pub.js"></script>
</head>

<body>
  <!-- Boutons top-bar -->
  <div class="top-buttons top-buttons-home">
    <a href="profil.html" class="btn-icon" title="Profil">
      <img src="assets/icons/user.svg" alt="Profil" />
      <span style="display:none;">Profil</span>
    </a>
    <a href="parametres.html" class="btn-icon" title="Paramètres">
      <img src="assets/icons/settings.svg" alt="Paramètres" />
      <span style="display:none;">Paramètres</span>
    </a>
  </div>

  <!-- -------- POPUP RGPD/CONSENT -------- -->
  <div id="popup-consent" class="popup-consent-bg" style="display:none;">
    <div class="popup-consent-box">
      <h2 data-i18n="index.rgpd.title">Confidentialité & Publicités</h2>
      <p data-i18n="index.rgpd.body1">
        VBlocks utilise des identifiants publicitaires pour diffuser des pubs personnalisées.<br>
        Tu peux refuser ou accepter la personnalisation.
      </p>
      <small data-i18n="index.rgpd.body2">(Tu peux changer d'avis plus tard dans les paramètres)</small>

      <!-- ✅ Choix publicités + notifications -->
      <div style="text-align:left;margin-top:.75rem">
        <div class="row">
          <input type="checkbox" id="consent-ads" />
          <label for="consent-ads" data-i18n="index.rgpd.ads">Autoriser la personnalisation des publicités</label>
        </div>
        <div class="row">
          <input type="checkbox" id="consent-push" />
          <label for="consent-push" data-i18n="index.rgpd.push">Recevoir des notifications</label>
        </div>
      </div>

      <div class="actions">
        <button id="consent-refuse" data-i18n="index.rgpd.refuse">Refuser</button>
        <button id="consent-accept" class="primary" data-i18n="index.rgpd.accept">Accepter</button>
      </div>
    </div>
  </div>
  <!-- -------- FIN POPUP RGPD/CONSENT -------- -->

  <!-- Trait bleu avec solde + score à battre -->
  <div class="barre-info">
    <div class="gauche">
      <span class="pill" id="soldeVCoins" data-i18n="index.balance">Solde : 0 VCoins</span>
    </div>
    <div class="droite">
      <span class="pill info-score" id="scoreABattre" data-i18n="index.highscore">Score à battre : —</span>
    </div>
  </div>

  <!-- MENU -->
  <main style="max-width: 680px; margin: 0 auto; padding: 14px;">
    <a href="lobby.html" class="menu-btn green">
      <div class="thumb">
        <img src="assets/thumbs/clicker.jpg" alt="Clicker VPlay" />
      </div>
      <span class="btn-label">
        <strong data-i18n="index.menu.clicker">Clicker VPlay</strong>
        <small data-i18n="index.menu.clicker_desc">Clique pour gagner des VCoins</small>
      </span>
      <span class="info-btn" data-i18n-tip="index.menu.clicker_tip" data-tip="Clique pour gagner rapidement">?</span>
    </a>

    <a id="btnConcours" href="concours.html" class="menu-btn orange" style="display:none;">
      <div class="thumb">
        <img src="assets/thumbs/concours.jpg" alt="Concours Photo" />
      </div>
      <span class="btn-label">
        <strong data-i18n="index.menu.concours">Concours Photo</strong>
        <small data-i18n="index.menu.concours_desc">Publie une photo, vote, gagne !</small>
        <span class="prix-blanc" data-i18n="index.menu.concours_prize">Prix du moment : 50€</span>
      </span>
      <span class="info-btn" data-i18n-tip="index.menu.concours_tip" data-tip="Concours selon pays éligibles">?</span>
    </a>

    <div id="tooltip" class="tooltip"></div>
  </main>

  <script>
    // --------- MAJ du solde/score affichés sur la barre bleue ----------
    async function refreshBarreInfo() {
      try {
        if (!window.sb || !window.sb.auth) return;
        const { data: { user } } = await window.sb.auth.getUser();
        const uid = user?.id || null;
        if (!uid) return;

        let q1 = await window.sb.from('users')
          .select('vcoins, best_score')
          .or(`auth_id.eq.${uid},id.eq.${uid}`)
          .maybeSingle();

        const solde = q1?.data?.vcoins ?? 0;
        const best  = q1?.data?.best_score ?? null;

        const elSolde = document.getElementById('soldeVCoins');
        const elScore = document.getElementById('scoreABattre');
        if (elSolde) elSolde.textContent = `${solde} VCoins`;
        if (elScore) elScore.textContent = best ? `Score à battre : ${best}` : 'Score à battre : —';
      } catch(e) {
        console.warn('[barre-info] refresh', e?.message || e);
      }
    }

    // ---------------- Tooltips ----------------
    const tooltip = document.getElementById('tooltip');
    document.querySelectorAll('.info-btn').forEach(el => {
      el.addEventListener('click', function (e) {
        e.stopPropagation();
        let text = el.getAttribute('data-tip');
        if (window.i18nGet) {
          const key = el.getAttribute('data-i18n-tip');
          const translated = key ? window.i18nGet(key) : null;
          if (translated) text = translated;
        }
        const parentBtn = el.closest('.menu-btn');
        const rect = parentBtn.getBoundingClientRect();
        tooltip.innerHTML = text;
        tooltip.style.width = '';
        tooltip.style.display = 'block';
        const scrollTop = window.scrollY || window.pageYOffset;
        const scrollLeft = window.scrollX || window.pageXOffset;
        tooltip.style.top = (rect.bottom + scrollTop) + 'px';
        tooltip.style.left = (rect.left + rect.width/2 + scrollLeft) + 'px';
        tooltip.classList.add('visible');
      });
    });
    document.addEventListener('click', (e) => {
      if (!tooltip.contains(e.target)) {
        tooltip.classList.remove('visible');
        tooltip.style.display = 'none';
      }
    });
    ['resize','scroll'].forEach(evt => {
      window.addEventListener(evt, () => {
        if (tooltip.classList.contains('visible')) {
          tooltip.style.display = 'none';
          tooltip.classList.remove('visible');
        }
      });
    });

    // --------- POPUP consent (RGPD) ----------
    const CONSENT_KEY = 'consent';       // accept | refuse
    const ADS_KEY = 'ads_personalized';  // yes | no
    const ADS_ENABLED = 'ads_enabled';   // true | false

    function applyConsentFromLocal() {
      const consent = localStorage.getItem(CONSENT_KEY);
      const enabled = localStorage.getItem(ADS_ENABLED);
      if (window.pub && window.pub.setPersonalized) {
        window.pub.setPersonalized(enabled === 'true');
      }
    }

    function showPopupOnce() {
      try {
        const popup = document.getElementById('popup-consent');
        if (!popup) return;
        if (localStorage.getItem(CONSENT_KEY)) return; // déjà choisi
        popup.style.display = 'block';
      } catch(_) {}
    }

    async function syncConsentFromCloud() {
      try {
        if (!window.sb) return false;
        const { data: { user } } = await window.sb.auth.getUser();
        const uid = user?.id || null;
        if (!uid) return false;

        let q = await window.sb.from('users')
          .select('ads_consent')
          .or(`auth_id.eq.${uid},id.eq.${uid}`)
          .maybeSingle();

        const c = q?.data?.ads_consent || null;
        if (c) {
          localStorage.setItem(CONSENT_KEY, c);
          localStorage.setItem(ADS_ENABLED, c === 'accept' ? 'true' : 'false');
          localStorage.setItem(ADS_KEY, c === 'accept' ? 'yes' : 'no');
          return true;
        }
      } catch(e) { console.warn('[consent] cloud sync', e?.message || e); }
      return false;
    }

    async function checkAndShowPopupOnce() {
      try {
        if (localStorage.getItem(CONSENT_KEY)) {
          applyConsentFromLocal();
          return;
        }
        const cloud = await syncConsentFromCloud();
        if (cloud) {
          applyConsentFromLocal();
          return;
        }
        showPopupOnce();
      } catch(e) {
        console.warn('[consent] bootstrap error', e?.message || e);
        showPopupOnce();
      }

      // Boutons popup
      const btnAccept = document.getElementById("consent-accept");
      const btnRefuse = document.getElementById("consent-refuse");
      const cbAds     = document.getElementById("consent-ads");
      const popup     = document.getElementById("popup-consent");
      const cbPush    = document.getElementById("consent-push"); // 👈

      if (btnAccept) {
        btnAccept.onclick = async function() {
          // pubs
          localStorage.setItem(CONSENT_KEY, "accept");
          localStorage.setItem(ADS_KEY,   cbAds && cbAds.checked ? "yes" : "no");
          localStorage.setItem(ADS_ENABLED, cbAds && cbAds.checked ? "true" : "false");

          // push opt-in
          const wantPush = cbPush && cbPush.checked;
          localStorage.setItem('push_optin', wantPush ? 'yes' : 'no');

          if (popup) popup.style.display = "none";
          applyConsentFromLocal();

          try {
            if (window.bootstrapAuthAndProfile) await window.bootstrapAuthAndProfile();
            if (window.sb?.rpc) await window.sb.rpc('update_ads_consent', { new_consent: "accept" });
          } catch(e) { console.warn('[consent] update accept RPC', e?.message || e); }

          // Demande permission push uniquement si opt-in
          if (wantPush && window.__initPushOnce) {
            try { await window.__initPushOnce(); } catch(e) {}
          }
        };
      }
      if (btnRefuse) {
        btnRefuse.onclick = async function() {
          localStorage.setItem(CONSENT_KEY, "refuse");
          localStorage.setItem(ADS_KEY, "no");
          localStorage.setItem(ADS_ENABLED, "false");
          localStorage.setItem('push_optin', 'no'); // 👈
          if (popup) popup.style.display = "none";
          applyConsentFromLocal();
          try {
            if (window.bootstrapAuthAndProfile) await window.bootstrapAuthAndProfile();
            if (window.sb?.rpc) await window.sb.rpc('update_ads_consent', { new_consent: "refuse" });
          } catch(e) { console.warn('[consent] update refuse RPC', e?.message || e); }
        };
      }
    }

    /* ==== AFFICHER CONCOURS SELON PAYS ==== */
    async function getUserCountryCode() {
      try {
        const { data: { user } } = await window.sb.auth.getUser();
        const uid = user?.id || null;
        if (!uid) return null;

        let q = await window.sb.from('users')
          .select('country,lang')
          .or(`auth_id.eq.${uid},id.eq.${uid}`)
          .maybeSingle();

        let cc = (q?.data?.country || '').toUpperCase();
        if (!cc) {
          let lang = (q?.data?.lang || navigator.language || 'en-US').toUpperCase();
          cc = lang.includes('-') ? lang.split('-').pop() : (lang.length>2 ? lang.slice(-2) : lang);
        }
        return cc || null;
      } catch { return null; }
    }

    async function checkConcoursStatusByCountry() {
      const btn = document.getElementById('btnConcours');
      if (!btn) return;

      try {
        const { data, error } = await window.sb
          .from('config')
          .select('concours_enabled, concours_countries')
          .eq('id', 'GLOBAL')
          .maybeSingle();

        if (error) throw error;

        const enabled = !!data?.concours_enabled;
        const list    = Array.isArray(data?.concours_countries) ? data.concours_countries : null;

        if (!enabled) { btn.style.display = 'none'; return; }

        const cc = await getUserCountryCode();
        if (!cc) { btn.style.display = 'none'; return; }

        const ok = !list || list.includes(cc);
        btn.style.display = ok ? 'block' : 'none';
      } catch(e) {
        console.warn('[concours] status', e?.message || e);
        const el = document.getElementById('btnConcours');
        if (el && el.style) el.style.display = 'none';
      }
    }

    // ---- Boot langue local-first + auth/profile ----
    async function bootstrapLanguageLocalFirst() {
      try {
        if (window.i18nBootstrap) await window.i18nBootstrap();
        if (window.bootstrapAuthAndProfile) {
          await window.bootstrapAuthAndProfile();
        }
        if (window.userData?.getProfileSecure && window.userData?.getLang && window.userData?.updateLangDirect) {
          const prof  = await window.userData.getProfileSecure();
          const local = window.userData.getLang();
          if (!prof?.lang || prof.lang !== local) {
            await window.userData.updateLangDirect(local);
          }
        }
      } catch (e) {
        console.warn('[lang bootstrap local-first]', e?.message || e);
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      try {
        await bootstrapLanguageLocalFirst();

        await checkConcoursStatusByCountry();
        await checkAndShowPopupOnce();
        await listenPopupsRealtime?.();

        if (window.i18nTranslateAll) window.i18nTranslateAll();

        // Relance auto push si l’utilisateur avait déjà opt-in
        if (localStorage.getItem('push_optin') === 'yes' && window.__initPushOnce) {
          try { await window.__initPushOnce(); } catch(e){}
        }

        if (typeof refreshBarreInfo === 'function') {
          await refreshBarreInfo();
        }
      } catch (e) {
        console.warn('[INDEX bootstrap]', e?.message || e);
      }
    });
  </script>

  <!-- Push (FCM) : init + enregistrement token dans Supabase -->
  <script>
    (function () {
      const DEBUG_PUSH = false;
      let inited = false;

      function isNative() {
        try { return window.Capacitor?.getPlatform?.() !== 'web'; }
        catch(_) { return false; }
      }

      async function savePushTokenToSupabase(token){
        try{
          if(!token || !window.sb) return;
          const uid = await (window.userData?.getAuthUserId?.() || null);
          if(!uid) return;
          const lang = (localStorage.getItem('langue') || 'EN').toUpperCase();
          const platform = window.Capacitor?.getPlatform?.() || 'android';
          await window.sb.from('user_push_tokens').upsert(
            [{ token, user_id: uid, platform, lang }],
            { onConflict: 'token' }
          );
        }catch(e){ if (DEBUG_PUSH) console.warn('[Push] save token fail', e); }
      }

      async function initPush() {
        if (inited) return; inited = true;
        if (!isNative()) return;
        const Push = window.Capacitor?.Plugins?.PushNotifications;
        if (!Push) return;
        try {
          const perm = await Push.requestPermissions();
          if (perm.receive !== 'granted') return;
          await Push.register();

          Push.addListener('registration', async ({ value }) => {
            localStorage.setItem('fcmToken', value || '');
            if (DEBUG_PUSH) console.log('[Push] FCM token:', value);
            await savePushTokenToSupabase(value);
          });
          Push.addListener('registrationError', (err) => {
            if (DEBUG_PUSH) console.error('[Push] registration error', err);
          });
          Push.addListener('pushNotificationReceived', (n) => {
            if (DEBUG_PUSH) console.log('[Push] reçu (FG)', n);
          });
          Push.addListener('pushNotificationActionPerformed', (a) => {
            if (DEBUG_PUSH) console.log('[Push] action', a);
          });
        } catch (e) { if (DEBUG_PUSH) console.error('[Push] init error', e); }
      }
      window.__initPushOnce = initPush;
    })();
  </script>

  <!-- ===== Bannière MAJ non bloquante + logique AppUpdate / Store ===== -->
  <div id="update-banner">
    <h4 data-i18n="index.update.title">Mise à jour disponible</h4>
    <p data-i18n="index.update.body">Une nouvelle version est prête. Tu peux l’installer maintenant.</p>
    <div class="actions">
      <button id="btn-update-later" data-i18n="index.update.later">Plus tard</button>
      <button id="btn-update-now" class="primary" data-i18n="index.update.now">Mettre à jour</button>
    </div>
  </div>

  <script>
    (function(){
      const AppUpdate = window.Capacitor?.Plugins?.AppUpdate;
      const Browser   = window.Capacitor?.Plugins?.Browser;
      const Device    = window.Capacitor?.Plugins?.Device;
      const banner    = document.getElementById('update-banner');
      const btnNow    = document.getElementById('btn-update-now');
      const btnLater  = document.getElementById('btn-update-later');

      async function openStore() {
        try {
          const info = await Device.getInfo();
          if (info?.platform === 'ios') {
            await Browser.open({ url: 'https://apps.apple.com/app/idXXXXXXXXX' });
          } else {
            await Browser.open({ url: 'https://play.google.com/store/apps/details?id=com.vblocks.app' });
          }
        } catch(e) { console.warn('[AppUpdate] openStore', e); }
      }

      async function checkPlayUpdateAndMaybeShow() {
        try {
          if (!AppUpdate) return;
          const info = await AppUpdate.getAppUpdateInfo();
          if (info?.updateAvailability === 2 /* UPDATE_AVAILABLE */) {
            banner.style.display = 'block';
            btnNow.onclick = async () => {
              try {
                if (info.flexibleUpdateAllowed) {
                  await AppUpdate.startFlexibleUpdate();
                  banner.style.display = 'none';
                } else {
                  await openStore();
                }
              } catch (e) {
                console.warn('[AppUpdate] startFlexibleUpdate error', e);
                await openStore();
              }
            };
            btnLater.onclick = ()=>{ banner.style.display='none'; };
          } else {
            console.log('[AppUpdate] aucune mise à jour disponible');
          }
        } catch (e) {
          console.warn('[AppUpdate] getAppUpdateInfo error', e);
        }
      }

      document.addEventListener('DOMContentLoaded', checkPlayUpdateAndMaybeShow);
    })();
  </script>
</body>
</html>
